<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>3270Connect Dashboard</title>
  <link rel="shortcut icon" href="/static/images/logo.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.2.0"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- added jQuery dependency -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css">
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <!-- Yorkshire Mainframe Theme Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700;800&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Yorkshire Mainframe System palette */
      --background: #031611;
      --background-accent: radial-gradient(135% 135% at 50% -10%, rgba(77, 255, 176, 0.16), transparent 65%);
      --card: rgba(8, 52, 38, 0.94);
      --popover: rgba(10, 56, 41, 0.92);
      --input: rgba(10, 38, 30, 0.9);
      --muted: rgba(5, 30, 22, 0.65);

      --foreground: #cafee9;
      --card-foreground: #ecfff7;
      --popover-foreground: #d4ffee;
      --muted-foreground: #70e7b6;

      --primary: #4effb3;
      --primary-foreground: #02130a;
      --accent: #f7c36b;
      --accent-foreground: #04130b;
      --secondary: rgba(84, 160, 126, 0.78);
      --secondary-foreground: #dcfff3;

      --border: rgba(78, 255, 176, 0.38);
      --ring: rgba(78, 255, 176, 0.58);
      --destructive: #ff6f82;
      --destructive-foreground: #fff5f7;

      --radius: 0.75rem;
      --shadow-sm: 0 0 16px rgba(78, 255, 176, 0.14);
      --shadow-md: 0 0 28px rgba(78, 255, 176, 0.18);
      --shadow-lg: 0 0 40px rgba(78, 255, 176, 0.28);
    }

    html {
      height: 100%;
    }

    .header-subtext {
      font-size: 1rem;
      color: var(--muted-foreground);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .header-eyebrow {
      font-size: 0.85rem;
      color: var(--muted-foreground);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin: 0 0 8px;
    }

    .mainframe-header h1 {
      color: var(--card-foreground);
      text-shadow: 0 0 16px rgba(78, 255, 176, 0.28);
      letter-spacing: 0.06em;
      margin: 0;
    }

    .header-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
    }

    .header-actions-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-left: auto;
      align-items: flex-end;
    }

    .mainframe-shell {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 32px;
      min-height: 100%;
    }

    .mainframe-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 24px;
      align-items: stretch;
    }

    .panel {
      background: linear-gradient(186deg, rgba(9, 60, 43, 0.95) 0%, rgba(3, 20, 15, 0.97) 100%);
      border: 1px solid rgba(78, 255, 176, 0.26);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .panel::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: var(--radius);
      border: 1px solid rgba(78, 255, 176, 0.14);
      pointer-events: none;
    }

    .panel-header {
      padding: 20px 24px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.95rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted-foreground);
    }

    .panel-subtext {
      font-size: 0.75rem;
      color: var(--muted-foreground);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .panel-body {
      padding: 0 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .terminal-panel .panel-header {
      color: var(--card-foreground);
    }

    .status-lights {
      display: flex;
      gap: 6px;
    }

    .status-lights .light {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      background-color: currentColor;
      box-shadow: 0 0 12px currentColor;
    }

    .status-lights .light.red { color: #ff6b6b; }
    .status-lights .light.amber { color: #f8d46a; }
    .status-lights .light.green { color: #3dff9a; }

    .terminal-body {
      font-family: 'JetBrains Mono', monospace;
      color: var(--card-foreground);
    }

    .terminal-line {
      font-size: 0.95rem;
      letter-spacing: 0.03em;
      color: var(--card-foreground);
    }

    .terminal-line.accent {
      color: var(--primary);
      font-weight: 700;
    }

    .terminal-line .success {
      color: var(--primary);
    }

    .terminal-line .muted {
      color: var(--muted-foreground);
    }

    .terminal-line .numeric {
      color: var(--accent);
      font-weight: 700;
    }

    .terminal-divider {
      margin: 12px 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(61, 255, 154, 0.4), transparent);
    }

    .terminal-prompt {
      margin: 0;
      color: var(--primary);
    }

    .command-panel {
      gap: 0;
    }

    .metric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 18px;
      padding: 0 24px 24px;
    }

    .metric-tile {
      background: rgba(6, 30, 23, 0.9);
      border: 1px solid rgba(78, 255, 176, 0.22);
      border-radius: calc(var(--radius) - 0.35rem);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: inset 0 0 18px rgba(6, 48, 34, 0.4);
    }

    .metric-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted-foreground);
    }

    .metric-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.9rem;
      font-weight: 700;
      color: var(--card-foreground);
    }

    .metric-trend {
      font-size: 0.75rem;
      color: var(--muted-foreground);
      letter-spacing: 0.05em;
    }

    .command-actions {
      padding: 0 24px 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-start;
    }

    .interface-button {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      border-radius: var(--radius);
      border: 1px solid rgba(78, 255, 176, 0.25);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: rgba(78, 255, 176, 0.14);
      color: var(--card-foreground);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .interface-button.secondary {
      background: rgba(78, 255, 176, 0.06);
    }

    .interface-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
      background: rgba(78, 255, 176, 0.22);
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(0, 1fr));
      gap: 18px;
      padding: 0 24px 24px;
      width: 100%;
    }

    .chart-card {
      background: rgba(7, 36, 27, 0.9);
      border: 1px solid rgba(78, 255, 176, 0.18);
      border-radius: calc(var(--radius) - 0.4rem);
      padding: 18px;
      box-shadow: inset 0 0 18px rgba(6, 48, 34, 0.55);
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 100%;
    }

    .chart-card-header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      color: var(--card-foreground);
    }

    .chart-card-header h3 {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.1rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin: 0;
    }

    .chart-slider {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      color: var(--card-foreground);
      font-size: 0.85rem;
      font-weight: 500;
    }

    .chart-slider input[type="range"] {
      flex: 1;
      min-width: 160px;
    }

    .chart-container {
      position: relative;
      width: 100%;
      height: 260px;
    }

    .chart-card canvas {
      width: 100% !important;
    }

    .status-panel {
      gap: 0;
    }

    .status-section {
      padding: 12px 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-bottom: 1px solid rgba(61, 255, 154, 0.12);
    }

    .status-section:last-of-type {
      border-bottom: none;
    }

    .status-section h4 {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted-foreground);
      margin: 0;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      color: var(--muted-foreground);
    }

    .status-item .value {
      color: var(--accent);
      font-weight: 700;
    }

    .status-meter {
      height: 6px;
      border-radius: 999px;
      background: rgba(61, 255, 154, 0.12);
      overflow: hidden;
    }

    .status-meter span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, rgba(61, 255, 154, 0.6), rgba(61, 255, 154, 1));
      border-radius: inherit;
    }

    .automation-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .automation-form .form-check {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .form-check-label {
      color: var(--muted-foreground);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 0.8rem;
    }

    .automation-form label.form-label {
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      color: var(--muted-foreground);
      text-transform: uppercase;
    }

    .process-panel .panel-body {
      padding-top: 16px;
      overflow-x: auto;
    }

    #pidParamsContainerOnDashboard {
      background: linear-gradient(188deg, rgba(3, 24, 18, 0.96) 0%, rgba(2, 14, 10, 0.98) 100%);
      border: 1px solid rgba(61, 255, 154, 0.18);
      border-radius: calc(var(--radius) - 0.35rem);
      padding: 16px;
      box-shadow: inset 0 0 22px rgba(2, 14, 10, 0.6);
      overflow-x: auto;
    }

    #pidParamsContainerOnDashboard table {
      background: transparent;
    }

    #pidParamsContainerOnDashboard table.table {
      --bs-table-color: var(--card-foreground);
      --bs-table-bg: rgba(3, 24, 18, 0.96);
      --bs-table-striped-bg: rgba(6, 40, 29, 0.88);
      --bs-table-striped-color: var(--card-foreground);
      --bs-table-hover-bg: rgba(6, 40, 29, 0.9);
      --bs-table-hover-color: var(--card-foreground);
      --bs-table-border-color: rgba(61, 255, 154, 0.18);
      background-color: var(--bs-table-bg);
      color: var(--card-foreground);
      border: 1px solid rgba(61, 255, 154, 0.18);
      border-radius: calc(var(--radius) - 0.35rem);
      overflow: hidden;
    }

    #pidParamsContainerOnDashboard table.table thead {
      background-color: rgba(6, 30, 23, 0.95);
      color: var(--primary);
    }

    #pidParamsContainerOnDashboard table.table thead th {
      border: none;
      border-bottom: 1px solid rgba(61, 255, 154, 0.18);
    }

    #pidParamsContainerOnDashboard table.table-hover tbody tr:hover {
      box-shadow: inset 0 0 12px rgba(0, 255, 128, 0.08);
    }

    #pidParamsContainerOnDashboard table.table tbody tr {
      background-color: rgba(4, 26, 19, 0.92) !important;
    }

    #pidParamsContainerOnDashboard table.table tbody td {
      color: var(--card-foreground);
    }

    .process-panel table {
      color: var(--card-foreground);
      background: transparent;
    }

    .process-panel thead th {
      border-bottom: 1px solid rgba(61, 255, 154, 0.2);
      color: var(--primary);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
    }

    .process-panel tbody tr {
      border-top: 1px solid rgba(61, 255, 154, 0.08);
    }

    .action-icon {
      cursor: pointer;
      margin: 0 6px;
      transition: transform 0.2s ease, color 0.2s ease;
    }

    .action-icon:hover {
      transform: scale(1.1);
      color: var(--primary);
    }

    .mainframe-footer {
      text-align: center;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted-foreground);
      padding: 16px 8px 24px;
      border-top: 1px solid rgba(61, 255, 154, 0.1);
      margin-top: auto;
    }

    .mainframe-footer span {
      display: block;
    }

    /* CRT Screen Effect */
    .crt-screen {
      background:
        linear-gradient(180deg, rgba(0, 0, 0, 0.55), rgba(0, 0, 0, 0.75)),
        radial-gradient(ellipse at center, rgba(0, 255, 128, 0.08) 0%, transparent 65%),
        linear-gradient(transparent 0%, rgba(0, 255, 128, 0.04) 50%, transparent 100%),
        var(--card);
      position: relative;
    }

    .crt-screen::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(0, 255, 128, 0.04) 2px,
          rgba(0, 255, 128, 0.04) 4px
        );
      pointer-events: none;
      z-index: 1;
    }

    /* Cursor Blink Animation */
    @keyframes cursor-blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .cursor {
      animation: cursor-blink 1s infinite;
      color: var(--primary);
    }

    /* System Glow Effect */
    .system-glow {
      box-shadow: 
        0 0 10px rgba(0, 255, 128, 0.3),
        inset 0 0 10px rgba(0, 255, 128, 0.1);
    }

    /* Modern Navbar */
    .navbar {
      background: var(--card) !important;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      border-bottom: 1px solid var(--border);
    }

    .navbar-brand {
      font-weight: 700;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: transform 0.3s ease;
      font-family: 'JetBrains Mono', monospace;
      color: var(--primary) !important;
    }

    .navbar-brand:hover {
      transform: scale(1.05);
      text-shadow: 0 0 8px rgba(0, 255, 128, 0.4);
    }

    .navbar-brand img {
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
    }

    /* Modern Buttons */
    .btn {
      border-radius: var(--radius);
      padding: 10px 24px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      font-family: 'Inter', sans-serif;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn-primary {
      background: var(--primary);
      color: var(--primary-foreground);
      border-color: var(--primary);
    }

    .btn-primary:hover {
      background: var(--primary);
      box-shadow: 0 0 15px rgba(0, 255, 128, 0.4);
    }

    .btn-success {
      background: var(--accent);
      color: var(--accent-foreground);
      border-color: var(--accent);
    }

    .btn-success:hover {
      background: var(--accent);
      box-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
    }

    .btn-secondary {
      background: var(--secondary);
      color: var(--secondary-foreground);
      border-color: var(--secondary);
    }

    .btn-light {
      background: var(--card);
      color: var(--foreground);
      border-color: var(--border);
    }

    .btn-danger {
      background: var(--destructive);
      color: var(--destructive-foreground);
      border-color: var(--destructive);
    }

    .btn-danger:hover {
      background: var(--destructive);
      box-shadow: 0 0 15px rgba(255, 82, 82, 0.4);
    }

    /* Hero Section with Gradient */
    .hero-section {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      padding: 40px;
      margin-bottom: 32px;
      position: relative;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary);
      box-shadow: 0 0 10px rgba(0, 255, 128, 0.5);
    }

    .hero-section h1 {
      color: var(--primary);
      font-weight: 800;
      margin-bottom: 8px;
      font-family: 'JetBrains Mono', monospace;
      text-shadow: 0 0 10px rgba(0, 255, 128, 0.3);
    }

    .hero-section .subtitle {
      color: var(--muted-foreground);
      font-size: 1.1rem;
      font-weight: 500;
      font-family: 'Inter', sans-serif;
    }

    /* Modern Metric Cards */
    .metric-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      margin: 12px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
      border: 1px solid var(--border);
      min-width: 200px;
      position: relative;
    }

    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .metric-card.active {
      border-left-color: var(--primary);
      box-shadow: 0 0 10px rgba(0, 255, 128, 0.2);
    }

    .metric-card.started {
      border-left-color: var(--accent);
      box-shadow: 0 0 10px rgba(255, 193, 7, 0.2);
    }

    .metric-card.completed {
      border-left-color: var(--primary);
      box-shadow: 0 0 10px rgba(0, 255, 128, 0.2);
    }

    .metric-card.failed {
      border-left-color: var(--destructive);
      box-shadow: 0 0 10px rgba(255, 82, 82, 0.2);
    }

    .metric-card h5 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--muted-foreground);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      font-family: 'JetBrains Mono', monospace;
    }

    .metric-card .metric-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary);
      margin: 0;
      font-family: 'JetBrains Mono', monospace;
      text-shadow: 0 0 10px rgba(0, 255, 128, 0.3);
    }

    .metric-card .metric-icon {
      font-size: 2rem;
      opacity: 0.2;
      position: absolute;
      right: 24px;
      top: 24px;
      color: var(--primary);
    }

    /* Chart Container */
    .chart-wrapper {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-md);
      margin-bottom: 24px;
      transition: all 0.3s ease;
      border: 1px solid var(--border);
    }

    .chart-wrapper:hover {
      box-shadow: var(--shadow-lg);
    }

    .chart-wrapper h3 {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      font-family: 'JetBrains Mono', monospace;
    }

    .chart-container { 
      margin: auto; 
      height: 400px; 
      position: relative;
    }

    /* Modern Table Styling */
    .table-wrapper {
      background: var(--card);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-md);
      margin-top: 24px;
      border: 1px solid var(--border);
    }

    .table {
      margin-bottom: 0;
      color: var(--foreground);
    }

    .table thead {
      background: var(--primary);
      color: var(--primary-foreground);
    }

    .table thead th {
      border: none;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.85rem;
      padding: 16px;
      font-family: 'JetBrains Mono', monospace;
    }

    .table tbody tr {
      transition: all 0.2s ease;
      background: var(--card);
    }

    .table tbody tr:hover {
      background-color: var(--muted);
      transform: scale(1.01);
      box-shadow: 0 0 10px rgba(0, 255, 128, 0.1);
    }

    .table tbody td {
      padding: 16px;
      vertical-align: middle;
      border-bottom: 1px solid var(--border);
      color: var(--foreground);
    }

    /* Action Icons */
    .action-icon {
      font-size: 1.2rem;
      cursor: pointer;
      margin: 0 6px;
      transition: all 0.2s ease;
    }

    .action-icon:hover {
      transform: scale(1.2);
    }

    .action-icon.logs {
      color: var(--primary);
    }

    .action-icon.logs:hover {
      text-shadow: 0 0 8px rgba(0, 255, 128, 0.5);
    }

    .action-icon.kill {
      color: var(--destructive);
    }

    .action-icon.kill:hover {
      text-shadow: 0 0 8px rgba(255, 82, 82, 0.5);
    }

    .action-icon.workflow {
      color: #5bc0de;
    }

    .action-icon.workflow:hover {
      transform: scale(1.2);
      text-shadow: 0 0 8px rgba(91, 192, 222, 0.6);
    }

    .action-icon.output {
      color: #f0ad4e;
    }

    .action-icon.output:hover {
      transform: scale(1.2);
      text-shadow: 0 0 8px rgba(240, 173, 78, 0.6);
    }

    /* Modern Form Controls */
    .form-control, .form-select {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 10px 16px;
      transition: all 0.3s ease;
      background: var(--input);
      color: var(--foreground);
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 255, 128, 0.1);
      background: var(--input);
      color: var(--foreground);
    }

    .form-check-input:checked {
      background-color: var(--primary);
      border-color: var(--primary);
    }

    .form-label {
      font-weight: 600;
      color: var(--foreground);
      margin-bottom: 8px;
    }

    .form-range {
      accent-color: var(--primary);
    }

    /* Modern Modal */
    .modal-content {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      background: var(--card);
    }

    .modal-header {
      background: linear-gradient(186deg, rgba(8, 52, 38, 0.96) 0%, rgba(3, 20, 15, 0.98) 100%);
      color: var(--card-foreground);
      border-radius: var(--radius) var(--radius) 0 0;
      border-bottom: 1px solid rgba(78, 255, 176, 0.2);
      padding: 20px 24px;
      box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.35);
    }

    .modal-title {
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }

    .modal-body {
      padding: 24px;
      background: var(--card);
      color: var(--foreground);
    }

    .modal-footer {
      border-top: 1px solid var(--border);
      padding: 20px 24px;
      background: var(--card);
    }

    .btn-close {
      filter: brightness(0) invert(1);
    }

    #startProcessModal .modal-dialog {
      --bs-modal-width: min(900px, 95vw);
    }

    #startProcessModal .modal-body {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .config-preview-accordion .accordion-item {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: calc(var(--radius) - 0.35rem);
      overflow: hidden;
    }

    .config-preview-accordion .accordion-button {
      background: rgba(6, 30, 23, 0.92);
      color: var(--card-foreground);
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .config-preview-accordion .accordion-button:not(.collapsed) {
      box-shadow: inset 0 -1px 0 rgba(78, 255, 176, 0.2);
    }

    .accordion-button::after {
      content: "";
      display: inline-block;
      width: 1rem;
      height: 1rem;
      margin-left: auto;
      background-color: var(--card-foreground);
      -webkit-mask: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill-rule='evenodd' d='M1.5 6.5l6 6 6-6H1.5z'/%3e%3c/svg%3e") no-repeat center;
      mask: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill-rule='evenodd' d='M1.5 6.5l6 6 6-6H1.5z'/%3e%3c/svg%3e") no-repeat center;
      transition: transform 0.2s ease, background-color 0.2s ease;
    }

    /* Rotate when expanded */
    .accordion-button:not(.collapsed)::after {
      transform: rotate(180deg);
    }

    /* Optional hover or active effect (slightly brighter) */
    .accordion-button:hover::after,
    .accordion-button:not(.collapsed)::after {
      background-color: color-mix(in srgb, var(--card-foreground) 80%, white);
    }


    .config-preview-accordion .accordion-body {
      padding: 0;
      background: rgba(3, 24, 18, 0.96);
    }

    .config-preview-accordion pre {
      margin: 0;
      border: none;
      border-radius: 0;
      max-height: 260px;
      overflow: auto;
    }

    .override-fieldset {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      background: rgba(6, 30, 23, 0.85);
      box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.2);
    }

    .override-fieldset legend {
      padding: 0 12px;
      font-size: 0.85rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted-foreground);
      font-weight: 600;
    }

    .override-fieldset .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }

    .override-fieldset .form-grid .full-span {
      grid-column: 1 / -1;
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

  .form-text {
      margin-top: .25rem;
      font-size: .875em;
      color: var(--muted-foreground);
  }

    @media (max-width: 768px) {
      .override-fieldset .form-grid .full-span {
        justify-content: flex-start;
      }

      .override-fieldset .form-grid .full-span .btn {
        width: 100%;
      }
    }

    /* Footer */
    footer {
      background: var(--card) !important;
      box-shadow: 0 -4px 16px rgba(0, 255, 128, 0.1);
      border-top: 1px solid var(--border);
    }

    footer a {
      color: var(--primary);
    }

    footer a:hover {
      text-shadow: 0 0 8px rgba(0, 255, 128, 0.5);
    }

    /* Auto Refresh Toggle */
    .settings-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow-sm);
      margin-top: 24px;
      border: 1px solid var(--border);
    }

    .form-check-input {
      cursor: pointer;
      width: 48px;
      height: 24px;
    }

    .auto-refresh-control {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      padding: 12px 18px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(78, 255, 176, 0.12);
      box-shadow: var(--shadow-sm);
      width: 340px;
      align-self: flex-start;
    }

    .auto-refresh-control .form-check,
    .auto-refresh-control .form-select {
      margin: 0;
    }

    .auto-refresh-control label {
      margin: 0;
      color: var(--muted-foreground);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 0.75rem;
    }

    .auto-refresh-meta {
      display: flex;
      align-items: center;
      gap: 0.85rem;
      padding-top: 0.5rem;
      border-top: 1px dashed rgba(255, 255, 255, 0.2);
      color: var(--muted-foreground);
    }

    .auto-refresh-info {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      font-size: 0.85rem;
      text-transform: none;
    }

    .auto-refresh-info small {
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.7);
    }

    .refresh-indicator {
      width: 36px;
      height: 36px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .refresh-indicator .indicator-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid var(--muted-foreground);
      position: relative;
      transition: border-color 0.3s ease;
    }

    .refresh-indicator .indicator-icon::after {
      content: '';
      position: absolute;
      inset: 2px;
      border-radius: 50%;
      border: 2px solid transparent;
      border-top-color: var(--muted-foreground);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .refresh-indicator.active .indicator-icon {
      border-color: var(--primary);
    }

    .refresh-indicator.active .indicator-icon::after {
      opacity: 1;
      border-top-color: var(--primary);
      animation: spin 0.9s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .logs-modal {
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: 100%;
      min-height: 0;
    }

    .logs-modal .logs-wrapper {
      display: flex;
      flex-direction: column;
      gap: 16px;
      flex: 1;
      min-height: 0;
    }

    .logs-modal .settings-card {
      margin-top: 0;
      flex-shrink: 0;
    }

    .logs-modal #logsContainer {
      flex: 1;
      min-height: 0;
      max-height: none;
      overflow-y: auto;
    }

    .logs-modal .logs-refresh {
      margin-bottom: 0;
    }

    #consoleModal .modal-dialog {
      width: 100%;
      max-width: min(960px, 95vw);
      margin: 16px auto;
      height: calc(100vh - 32px);
      display: flex;
    }

    #consoleModal .modal-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-height: 100%;
    }

    #consoleModal .modal-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      gap: 16px;
    }

    #pidParamsContainer {
      max-height: 180px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .pid-param-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-start;
    }

    .pid-param-row .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: normal;
    }

    .pid-param-row .pid-badge {
      flex: 0 0 auto;
    }

    .pid-param-row .param-badge {
      flex: 1 1 220px;
    }

    .pid-param-row .pid-label,
    .pid-param-row .param-label {
      font-weight: 600;
      opacity: 0.75;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 0.65rem;
    }

    .pid-param-row .pid-value,
    .pid-param-row .param-text {
      font-weight: 600;
      color: inherit;
    }

    .pid-param-row .param-text {
      word-break: break-word;
      overflow-wrap: anywhere;
      line-height: 1.35;
    }

    /* Toast Notification */
    #toast-container.toast-top-right {
      top: 80px !important;
      right: 20px;
    }

    .toast {
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
    }

    /* Logs Container */
    #logsContainer {
      background: var(--background) !important;
      border-radius: var(--radius);
      font-family: 'JetBrains Mono', monospace;
      border: 1px solid var(--border);
    }

    /* Badge Styling */
    .badge {
      border-radius: var(--radius);
      padding: 6px 12px;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
    }

    .bg-light {
      background-color: var(--card) !important;
      color: var(--foreground) !important;
    }

    .bg-dark {
      background-color: var(--background) !important;
      color: var(--foreground) !important;
    }

    .bg-secondary {
      background-color: var(--secondary) !important;
      color: var(--secondary-foreground) !important;
    }

    .bg-info {
      background-color: var(--primary) !important;
      color: var(--primary-foreground) !important;
    }

    .bg-warning {
      background-color: var(--accent) !important;
      color: var(--accent-foreground) !important;
    }

    .bg-success {
      background-color: var(--primary) !important;
      color: var(--primary-foreground) !important;
    }

    .bg-danger {
      background-color: var(--destructive) !important;
      color: var(--destructive-foreground) !important;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 48px 24px 0;
      background: linear-gradient(188deg, rgba(4, 26, 19, 0.92) 0%, rgba(3, 18, 14, 0.94) 38%, rgba(4, 40, 29, 0.96) 100%);
      background-image: var(--background-accent), linear-gradient(188deg, rgba(4, 26, 19, 0.92) 0%, rgba(3, 18, 14, 0.94) 38%, rgba(4, 40, 29, 0.96) 100%);
      border-radius: var(--radius);
      font-family: 'JetBrains Mono', monospace;
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .metric-card, .chart-wrapper, .table-wrapper {
      animation: fadeInUp 0.5s ease-out;
    }

    /* Loading State */
    .chart-container.loading::after {
      content: 'Loading...';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: 600;
      color: var(--muted-foreground);
      font-family: 'JetBrains Mono', monospace;
    }

    /* Alert Styling */
    .alert {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      font-family: 'Inter', sans-serif;
    }

    .alert-danger {
      background: var(--destructive);
      color: var(--destructive-foreground);
      border-color: var(--destructive);
    }

    .alert-info {
      background: var(--card);
      color: var(--foreground);
      border-color: var(--border);
    }

    /* Responsive Improvements */
    @media (max-width: 1200px) {
      .mainframe-grid {
        grid-template-columns: 1fr;
      }

      .header-actions {
        width: 100%;
        justify-content: flex-start;
      }

      .metric-grid {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 32px 16px 0;
      }

      .mainframe-shell {
        gap: 20px;
      }

      .command-actions {
        justify-content: flex-start;
      }

      .metric-grid {
        grid-template-columns: 1fr;
        padding: 0 16px 20px;
      }

      .chart-grid {
        grid-template-columns: 1fr;
        padding: 0 16px 20px;
      }

      .chart-container {
        height: 220px;
      }

      .panel-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }

    /* Maximized modal styles */
    .modal-maximized {
      max-width: calc(100vw - 32px) !important;
      margin: 16px auto !important;
      height: calc(100vh - 32px);
    }

    .modal-maximized .modal-content {
      height: 100%;
      border-radius: var(--radius);
    }

    .modal-maximized .modal-body {
      max-height: calc(100vh - 212px);
      overflow-y: auto;
    }

    .modal-maximized #logsContainer {
      max-height: calc(100vh - 482px) !important;
    }

    /* Table dark styling for logs */
    .table-dark {
      background: var(--background);
      color: var(--foreground);
    }

    .table-dark thead {
      background: var(--card);
      color: var(--primary);
      border-bottom: 1px solid var(--border);
    }

    .table-dark tbody tr {
      border-bottom: 1px solid var(--border);
    }

    .table-striped tbody tr:nth-of-type(odd) {
      background-color: var(--card);
    }
  </style>
</head>
<body class="crt-screen">
  <div class="mainframe-shell">
    <header class="mainframe-header">
      <div class="header-titles">
        <h1>3270Connect Dashboard<span class="cursor">â–ˆ</span></h1>
        <p class="header-subtext">Monitor workflows, resources, and process health at a glance</p>
      </div>
      <div class="header-actions">
        {{$refreshPeriod := printf "%v" .RefreshPeriod }}
        <form id="autoRefreshForm" class="auto-refresh-control" onsubmit="event.preventDefault();">
          <div class="form-check form-switch mb-0">
            <input class="form-check-input" type="checkbox" id="autoRefreshToggle" {{if .AutoRefreshEnabled}}checked{{end}} data-tippy-content="Toggle automatic dashboard refresh." onchange="handleAutoRefreshToggle()">
            <label class="form-check-label ms-2" for="autoRefreshToggle">Auto Refresh</label>
          </div>
          <div class="d-flex align-items-center gap-2">
            <label for="refreshPeriodSelect">Interval</label>
            <select class="form-select form-select-sm w-auto" id="refreshPeriodSelect" data-tippy-content="Choose how often the dashboard refreshes." onchange="handleRefreshPeriodChange()">
              <option value="1" {{if eq $refreshPeriod "1"}}selected{{end}}>1s</option>
              <option value="5" {{if eq $refreshPeriod "5"}}selected{{end}}>5s</option>
              <option value="10" {{if eq $refreshPeriod "10"}}selected{{end}}>10s</option>
              <option value="15" {{if eq $refreshPeriod "15"}}selected{{end}}>15s</option>
              <option value="30" {{if eq $refreshPeriod "30"}}selected{{end}}>30s</option>
              <option value="60" {{if eq $refreshPeriod "60"}}selected{{end}}>60s</option>
            </select>
          </div>
          <div class="auto-refresh-meta" aria-live="polite" aria-atomic="true">
            <span class="refresh-indicator" id="refreshIndicator">
              <span class="indicator-icon" id="refreshIndicatorIcon"></span>
            </span>
            <div class="auto-refresh-info">
              <span id="refreshTimestamp">Last refresh: --</span>
              <small id="refreshStatus">Waiting for the next update</small>
            </div>
          </div>
        </form>
        <div class="header-actions-buttons">
          <button class="interface-button" type="button" data-bs-toggle="modal" data-bs-target="#startProcessModal" data-tippy-content="Start a new 3270Connect process">
            <i class="fas fa-rocket"></i>
            Start Process
          </button>
          <button class="interface-button" type="button" data-bs-toggle="modal" data-bs-target="#startAppModal" data-tippy-content="Launch a sample 3270 app">
            <i class="fas fa-server"></i>
            Start App
          </button>
          <button class="interface-button" data-bs-toggle="modal" data-bs-target="#consoleModal" data-tippy-content="Show the console logs">
            <i class="fas fa-terminal"></i>
            Console Logs
          </button>
          <button class="interface-button" type="button" onclick="refreshDashboardData(true);" data-tippy-content="Force a manual refresh">
            <i class="fas fa-sync-alt"></i>
            Refresh
          </button>
        </div>
      </div>
    </header>

    <main class="mainframe-grid">
      <section class="panel command-panel">
        <div class="panel-header">
          <span>System Interface</span>
          <span class="panel-subtext">Live controls &amp; insights</span>
        </div>
        <div class="metric-grid">
          <div class="metric-tile">
            <span class="metric-label">Active Workflows</span>
            <span class="metric-value" data-refresh-key="activeWorkflows">{{.ActiveWorkflows}}</span>
            <span class="metric-trend">Currently running processes</span>
          </div>
          <div class="metric-tile">
            <span class="metric-label">Total Started</span>
            <span class="metric-value" data-refresh-key="totalWorkflowsStarted">{{.TotalWorkflowsStarted}}</span>
            <span class="metric-trend">Lifetime workflows launched</span>
          </div>
          <div class="metric-tile">
            <span class="metric-label">Completed</span>
            <span class="metric-value" data-refresh-key="totalWorkflowsCompleted">{{.TotalWorkflowsCompleted}}</span>
            <span class="metric-trend">Finished without error</span>
          </div>
          <div class="metric-tile">
            <span class="metric-label">Failed</span>
            <span class="metric-value" data-refresh-key="totalWorkflowsFailed">{{.TotalWorkflowsFailed}}</span>
            <span class="metric-trend">Attention required</span>
          </div>
        </div>
        <div class="chart-grid">
          <div class="chart-card" data-tippy-content="Workflow duration over time.">
            <div class="chart-card-header">
              <h3><i class="fas fa-clock me-2"></i> Workflow Duration</h3>
              <div class="chart-slider">
                <span>Show last <span id="durationDataPointsValue">30</span> data points</span>
                <input type="range" class="form-range" id="durationDataPoints" min="10" max="100" value="30" step="5">
              </div>
            </div>
            <div class="chart-container">
              <canvas id="durationChart"></canvas>
            </div>
          </div>
          <div class="chart-card" data-tippy-content="CPU and memory utilisation.">
            <div class="chart-card-header">
              <h3><i class="fas fa-chart-line me-2"></i> System Resources</h3>
              <div class="chart-slider">
                <span>Show last <span id="resourcesDataPointsValue">30</span> data points</span>
                <input type="range" class="form-range" id="resourcesDataPoints" min="10" max="100" value="30" step="5">
              </div>
            </div>
            <div class="chart-container">
              <canvas id="cpuMemChart"></canvas>
            </div>
          </div>
        </div>
      </section>

    </main>

    <section class="panel process-panel">
      <div class="panel-header">
        <span>Process Intelligence</span>
        <span class="panel-subtext">Live PID overview</span>
      </div>
      <div class="panel-body">
        <div id="pidParamsContainerOnDashboard"></div>
      </div>
    </section>

    <footer class="mainframe-footer">
      <span>3270Connect Control Surface - Authenticated Session - Operator View</span>
      <span>Session v{{.Version}} - &copy; {{.Year}} 3270Connect</span>
      <span>"Where there's muck, there's brass." - "Where there's legacy code, there's opportunity."</span>
    </footer>
  </div>
  <!-- Tooltip for notifications -->
  <div id="tooltipNotification" class="tooltip bs-tooltip-top" role="tooltip" style="position: fixed; top: 10px; right: 10px; z-index: 9999; display: none;">
    <div class="tooltip-arrow"></div>
    <div class="tooltip-inner"></div>
  </div>
  <!-- Modal for Console Logs -->
  <div class="modal fade" id="consoleModal" tabindex="-1" aria-labelledby="consoleModalLabel" style="display: none;">
    <div class="modal-dialog modal-lg" id="consoleModalDialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="consoleModalLabel">Console Logs</h5>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-light" id="maximizeConsoleBtn" onclick="maximizeConsoleModal()" data-tippy-content="Maximize">
              <i class="fas fa-expand"></i>
            </button>
            <button type="button" class="btn btn-sm btn-light" id="restoreConsoleBtn" onclick="restoreConsoleModal()" style="display: none;" data-tippy-content="Restore">
              <i class="fas fa-compress"></i>
            </button>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
        </div>
        <div class="modal-body logs-modal">
          <div id="pidParamsContainer" class="settings-card"></div>
          <div class="settings-card">
            <label for="pidFilter" class="form-label">Filter by PID</label>
            <select id="pidFilter" class="form-select">
              <!-- Options will be auto populated -->
            </select>
          </div>
          <div class="logs-wrapper">
            <div class="p-3 bg-dark text-success" id="logsContainer" style="font-family: 'Courier New', Courier, monospace;">
              <!-- Logs will be loaded here -->
            </div>
            <div class="logs-refresh settings-card">
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="autoRefreshLogsCheckbox">
                <label class="form-check-label" for="autoRefreshLogsCheckbox">Auto Refresh</label>
              </div>
              <div class="d-flex flex-wrap align-items-center gap-3">
                <label for="logsRefreshInterval" class="form-label mb-0">Refresh Interval (seconds)</label>
                <select class="form-select form-select-sm w-auto" id="logsRefreshInterval">
                  <option value="1">1</option>
                  <option value="5">5</option>
                  <option value="10">10</option>
                  <option value="15">15</option>
                  <option value="30">30</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal for Starting 3270Connect Process -->
  <div class="modal fade" id="startProcessModal" tabindex="-1" aria-labelledby="startProcessModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="startProcessModalLabel">Start 3270Connect Process</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="startProcessForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="configFileInput" class="form-label">Configuration File</label>
              <input type="file" class="form-control" id="configFileInput" name="configFile" accept=".json" required>
            </div>
            <div id="configDetailsWrapper" class="mb-3 d-none">
              <div class="p-3 mb-3 bg-dark text-success border rounded">
                <div class="fw-bold text-info text-uppercase small mb-2">Workflow Metadata</div>
                <dl class="row mb-0" id="configMetadata"></dl>
              </div>
              <div class="config-preview-accordion">
                <div class="accordion" id="configPreviewAccordion">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="configPreviewHeading">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#configPreviewCollapse" aria-expanded="false" aria-controls="configPreviewCollapse">
                        Configuration Preview
                      </button>
                    </h2>
                    <div id="configPreviewCollapse" class="accordion-collapse collapse" aria-labelledby="configPreviewHeading" data-bs-parent="#configPreviewAccordion">
                      <div class="accordion-body">
                        <pre id="configPreview" class="bg-dark text-success p-3 small"></pre>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <fieldset class="override-fieldset mb-3 d-none" id="overridesFieldset">
              <legend>Overrides (optional)</legend>
              <div class="form-grid">
                <div>
                  <label for="overrideHostInput" class="form-label">Host Override</label>
                  <input type="text" class="form-control" id="overrideHostInput" name="overrideHost" placeholder="Leave blank to use file value">
                </div>
                <div>
                  <label for="overridePortInput" class="form-label">Port Override</label>
                  <input type="number" class="form-control" id="overridePortInput" name="overridePort" placeholder="Leave blank to use file value" min="1">
                </div>
                <div>
                  <label for="overrideOutputFilePathInput" class="form-label">Output File Override</label>
                  <input type="text" class="form-control" id="overrideOutputFilePathInput" name="overrideOutputFilePath" placeholder="Leave blank to use file value">
                </div>
                <div>
                  <label for="overrideRampUpBatchSizeInput" class="form-label">Ramp Up Batch Size Override</label>
                  <input type="number" class="form-control" id="overrideRampUpBatchSizeInput" name="overrideRampUpBatchSize" placeholder="Leave blank to use file value" min="1">
                </div>
                <div>
                  <label for="overrideRampUpDelayInput" class="form-label">Ramp Up Delay Override (seconds)</label>
                  <input type="number" class="form-control" id="overrideRampUpDelayInput" name="overrideRampUpDelay" placeholder="Leave blank to use file value" min="0" step="0.1">
                </div>
                <div class="full-span">
                  <button type="button" class="btn btn-success" id="testConnectionButton" onclick="testWorkflowConnection()" data-tippy-content="Verify connectivity to the configured host and port">
                    <i class="fas fa-plug me-2"></i>Test Connection
                  </button>
                </div>
              </div>
            </fieldset>
          <div class="mb-3">
            <label for="injectionConfigInput" class="form-label">Injection Config File (Optional)</label>
            <input type="file" class="form-control" id="injectionConfigInput" name="injectionConfig" accept=".json">
          </div>
            <div class="mb-3">
              <label for="tokenInput" class="form-label">RSA Token (Optional)</label>
              <input type="text" class="form-control" id="tokenInput" name="token" inputmode="numeric" autocomplete="one-time-code" placeholder="123456">
              <div class="form-text">Replaces any <code>{{"{{"}}token{{"}}"}}</code> placeholders right before execution.</div>
            </div>
            <div class="mb-3">
              <label for="concurrentInput" class="form-label">Concurrent Workflows</label>
              <input type="number" class="form-control" id="concurrentInput" name="concurrent" placeholder="Enter number of concurrent workflows" value="5" required>
            </div>
            <div class="mb-3">
              <label for="runtimeInput" class="form-label">Runtime Duration (seconds)</label>
              <input type="number" class="form-control" id="runtimeInput" name="runtime" placeholder="Enter runtime duration" value="180" required>
            </div>
            <div class="mb-3">
              <label for="startPortInput" class="form-label">Starting Port</label>
              <input type="number" class="form-control" id="startPortInput" name="startPort" placeholder="Enter starting port" value="5000" required>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="headlessInput" name="headless" checked>
              <label class=" ms-2 form-check-label" for="headlessInput">Headless Mode</label>
            </div>
          </form>
          <!-- New error container -->
          <div id="processErrors"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" data-tippy-content="Click to start the 3270Connect process" onclick="start3270ConnectProcess()">Start Process</button>
        </div>
      </div>
    </div>
  </div>
  <!-- New Modal for Starting 3270 App -->
  <div class="modal fade" id="startAppModal" tabindex="-1" aria-labelledby="startAppModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="startAppModalLabel">Start 3270 App</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="startAppForm" novalidate>
            <div class="mb-3">
              <label for="runAppSelect" class="form-label">Select Sample App</label>
              <select class="form-select" id="runAppSelect" name="runApp" required>
                <option value="">Choose...</option>
                <option value="1">Sample App 1</option>
                <option value="2">Sample App 2</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="runAppPortInput" class="form-label">App Port</label>
              <input type="number" class="form-control" id="runAppPortInput" name="runAppPort" placeholder="Enter port" value="3270" required>
            </div>
          </form>
          <!-- New error container for start app modal -->
          <div id="appProcessErrors"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-success" data-tippy-content="Click to start the sample 3270 app" onclick="start3270App()">Start App</button>
        </div>
      </div>
    </div>
  </div>

<!-- Modal for Kill Confirmation -->
<div class="modal fade" id="killModal" tabindex="-1" aria-labelledby="killModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="killModalLabel">Confirm Kill Process</h5>
        <button type="button" id="closeModal" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="killDetails"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirmKillBtn" class="btn btn-danger">Confirm Kill</button>
      </div>
    </div>
  </div>
</div>

<!-- Workflow Preview Modal -->
<div class="modal fade" id="workflowModal" tabindex="-1" aria-labelledby="workflowModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-bottom border-secondary">
        <h5 class="modal-title text-light" id="workflowModalLabel">Workflow JSON</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-break mb-2" style="color: #cafee9;"><strong>Path:</strong> <span id="workflowModalPath">Unknown</span></p>
        <pre id="workflowModalContent" class="bg-black rounded p-3" style="height: 60vh; overflow: auto; color: #4effb3;">Preparing workflow...</pre>
      </div>
    </div>
  </div>
</div>

<!-- Output Preview Modal -->
<div class="modal fade" id="outputModal" tabindex="-1" aria-labelledby="outputModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-lg-down modal-xl">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-bottom border-secondary">
        <h5 class="modal-title text-light" id="outputModalLabel">Live Output Preview</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2 mb-2">
          <small class="text-break" style="color: #cafee9;" id="outputModalPath">Output path unavailable</small>
          <div class="d-flex align-items-center gap-2">
            <button id="outputRefreshToggle" class="btn btn-sm btn-outline-success" onclick="toggleOutputAutoRefresh()" title="Toggle auto-refresh">
              <i class="fas fa-pause" id="outputRefreshIcon"></i>
            </button>
            <select id="outputRefreshInterval" class="form-select form-select-sm" style="width: auto; max-width: 120px;" onchange="updateOutputRefreshInterval()">
              <option value="2000">2s</option>
              <option value="4000" selected>4s</option>
              <option value="8000">8s</option>
              <option value="15000">15s</option>
            </select>
            <span class="small" style="color: #cafee9;" id="outputModalStatus">Auto-refresh every 4 seconds</span>
          </div>
        </div>
        <div class="ratio ratio-16x9">
          <iframe id="outputPreviewFrame" class="rounded border border-secondary" sandbox="allow-same-origin" srcdoc="<p class='text-light'>Loading output...</p>"></iframe>
        </div>
      </div>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  var autoRefreshEnabled = {{.AutoRefreshEnabled}};
  var refreshPeriod = {{.RefreshPeriod}};
  var refreshIntervalId = null;
  var autoRefreshPausedByModal = false;
  var modalOpenCount = 0;
  var metricsData = JSON.parse('{{.ExtendedJSON}}');
  var durationChart = null;
  var cpuMemChart = null;
  var durationSlider = null;
  var resourcesSlider = null;
  var refreshIndicatorElement = null;
  var refreshTimestampElement = null;
  var refreshStatusElement = null;
  var pidSelectElement = null;
  var refreshIndicatorTimeout = null;
  var colorPalette = [
    'rgba(102, 126, 234, 1)',
    'rgba(75, 192, 192, 1)',
    'rgba(255, 159, 64, 1)',
    'rgba(118, 75, 162, 1)',
    'rgba(255, 99, 132, 1)',
    'rgba(54, 162, 235, 1)',
    'rgba(153, 102, 255, 1)',
    'rgba(255, 206, 86, 1)'
  ];

  var processMetadataByPid = {};
  var workflowModalElement = null;
  var workflowModalContentElement = null;
  var workflowModalPathElement = null;
  var outputModalElement = null;
  var outputPreviewFrame = null;
  var outputModalStatusElement = null;
  var outputModalPathElement = null;
  var outputModalRefreshInterval = null;
  var outputModalCurrentPid = null;
  var outputModalAutoRefreshEnabled = true;
  var outputModalRefreshIntervalMs = 4000;

  function startAutoRefresh() {
    if (autoRefreshEnabled && !refreshIntervalId && !autoRefreshPausedByModal) {
      refreshIntervalId = setInterval(function() { refreshDashboardData(true); }, parseInt(refreshPeriod) * 1000);
      console.log("Auto refresh started");
    }
  }

  function stopAutoRefresh() {
    if (refreshIntervalId) {
      clearInterval(refreshIntervalId);
      refreshIntervalId = null;
      console.log("Auto refresh paused");
    }
  }

  function pauseAutoRefreshForModal() {
    if (!autoRefreshPausedByModal) {
      autoRefreshPausedByModal = true;
      stopAutoRefresh();
    }
  }

  function resumeAutoRefreshAfterModal() {
    if (modalOpenCount === 0) {
      autoRefreshPausedByModal = false;
      if (autoRefreshEnabled) {
        startAutoRefresh();
      }
    }
  }

  function handleAutoRefreshToggle() {
    var checkbox = document.getElementById('autoRefreshToggle');
    autoRefreshEnabled = checkbox.checked;
    autoRefreshPausedByModal = modalOpenCount > 0;

    if (!autoRefreshEnabled) {
      stopAutoRefresh();
    } else if (!autoRefreshPausedByModal) {
      startAutoRefresh();
      refreshDashboardData(true);
    }
    var url = new URL(window.location.href);

    if (checkbox.checked) {
      url.searchParams.set('autoRefresh', 'true');
    } else {
      url.searchParams.set('autoRefresh', 'false');
    }

    var refreshPeriodSelect = document.getElementById('refreshPeriodSelect');
    if (refreshPeriodSelect && refreshPeriodSelect.value) {
      url.searchParams.set('refreshPeriod', refreshPeriodSelect.value);
    }

    window.location.href = url.toString();
    if (refreshStatusElement) {
      refreshStatusElement.textContent = autoRefreshEnabled ? 'Waiting for the next update' : 'Auto-refresh disabled';
    }
  }

  function handleRefreshPeriodChange() {
    var select = document.getElementById('refreshPeriodSelect');
    if (!select) { return; }
    var checkbox = document.getElementById('autoRefreshToggle');
    var url = new URL(window.location.href);

    if (select.value) {
      url.searchParams.set('refreshPeriod', select.value);
    }

    if (checkbox && checkbox.checked) {
      url.searchParams.set('autoRefresh', 'true');
    } else {
      url.searchParams.set('autoRefresh', 'false');
    }

    window.location.href = url.toString();
  }

  function triggerRefreshIndicator() {
    if (!refreshIndicatorElement) {
      return;
    }
    refreshIndicatorElement.classList.add('active');
    if (refreshIndicatorTimeout) {
      clearTimeout(refreshIndicatorTimeout);
    }
    refreshIndicatorTimeout = setTimeout(function() {
      refreshIndicatorElement.classList.remove('active');
    }, 1200);
    if (refreshStatusElement) {
      refreshStatusElement.textContent = 'Refreshing...';
    }
  }

  function updateRefreshTimestamp(timestamp) {
    if (!refreshTimestampElement) {
      return;
    }
    var timeValue = typeof timestamp === 'number' ? new Date(timestamp * 1000) : new Date();
    if (isNaN(timeValue.getTime())) {
      timeValue = new Date();
    }
    refreshTimestampElement.textContent = 'Last refresh: ' + timeValue.toLocaleTimeString();
    if (refreshStatusElement) {
      refreshStatusElement.textContent = autoRefreshEnabled ? 'Waiting for the next update' : 'Auto-refresh disabled';
    }
  }

  function updateHeaderMetrics(aggregatedMetrics) {
    if (!aggregatedMetrics) {
      return;
    }
    var mapping = {
      activeWorkflows: aggregatedMetrics.activeWorkflows,
      totalWorkflowsStarted: aggregatedMetrics.totalWorkflowsStarted,
      totalWorkflowsCompleted: aggregatedMetrics.totalWorkflowsCompleted,
      totalWorkflowsFailed: aggregatedMetrics.totalWorkflowsFailed
    };
    Object.keys(mapping).forEach(function(key) {
      var node = document.querySelector('[data-refresh-key="' + key + '"]');
      if (node) {
        var value = mapping[key];
        node.textContent = typeof value === 'number' ? value : (value || '0');
      }
    });
  }

  function computeAggregatedSeries() {
    var aggregatedCPU = [];
    var cpuCount = [];
    var hostMemory = [];
    var hostMetric = metricsData.length ? metricsData[0] : null;

    metricsData.forEach(function(metric) {
      if (!hostMetric || (typeof metric.pid === 'number' && metric.pid < hostMetric.pid)) {
        hostMetric = metric;
      }
      if (metric.cpuUsage) {
        metric.cpuUsage.forEach(function(val, index) {
          if (typeof aggregatedCPU[index] === 'undefined') {
            aggregatedCPU[index] = 0;
            cpuCount[index] = 0;
          }
          aggregatedCPU[index] += val;
          cpuCount[index] += 1;
        });
      }
    });

    for (var i = 0; i < aggregatedCPU.length; i++) {
      if (cpuCount[i]) {
        aggregatedCPU[i] = aggregatedCPU[i] / cpuCount[i];
      }
    }

    if (hostMetric && hostMetric.memoryUsage) {
      hostMemory = hostMetric.memoryUsage.slice();
    }

    return { aggregatedCPU: aggregatedCPU, hostMemory: hostMemory };
  }

  function buildDurationData(dataPointLimit) {
    var maxCount = 0;
    metricsData.forEach(function(metric) {
      var durations = metric.durations || [];
      if (durations.length > maxCount) {
        maxCount = durations.length;
      }
    });
    var labels = [];
    for (var i = 0; i < maxCount; i++) { labels.push(i + 1); }
    var limitedLabels = labels.slice(-dataPointLimit);
    var datasets = [];
    var firstDataIndex = limitedLabels.length;

    metricsData.forEach(function(metric, index) {
      var durations = metric.durations || [];
      var padding = Math.max(maxCount - durations.length, 0);
      var fullData = new Array(padding).fill(null).concat(durations);
      var limitedData = fullData.slice(-dataPointLimit);
      var color = colorPalette[index % colorPalette.length];
      var dataset = {
        label: "PID " + metric.pid,
        data: limitedData,
        borderColor: color,
        backgroundColor: color.replace("1)", "0.1)"),
        fill: true,
        tension: 0.4,
        borderWidth: 3,
        pointRadius: 4,
        pointHoverRadius: 6,
        pointBackgroundColor: color,
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      };

      var firstValueIndex = dataset.data.findIndex(function(value) { return value !== null && value !== undefined; });
      if (firstValueIndex !== -1 && firstValueIndex < firstDataIndex) {
        firstDataIndex = firstValueIndex;
      }

      datasets.push(dataset);
    });

    if (firstDataIndex > 0 && firstDataIndex < limitedLabels.length) {
      limitedLabels = limitedLabels.slice(firstDataIndex);
      datasets = datasets.map(function(dataset) {
        return Object.assign({}, dataset, {
          data: dataset.data.slice(firstDataIndex)
        });
      });
    }

    return { labels: limitedLabels, datasets: datasets };
  }

  function buildResourceData(dataPointLimit, aggregatedCPU, hostMemory) {
    var maxLen = Math.max(aggregatedCPU.length, hostMemory.length);
    var labels = [];
    for (var i = 0; i < maxLen; i++) { labels.push(" " + (i + 1)); }
    var limitedLabels = labels.slice(-dataPointLimit);
    var fullCpuData = new Array(Math.max(maxLen - aggregatedCPU.length, 0)).fill(null).concat(aggregatedCPU);
    var fullMemData = new Array(Math.max(maxLen - hostMemory.length, 0)).fill(null).concat(hostMemory);

    var datasets = [{
      label: "CPU Usage (%)",
      data: fullCpuData.slice(-dataPointLimit),
      borderColor: "rgba(102, 126, 234, 1)",
      backgroundColor: "rgba(102, 126, 234, 0.1)",
      fill: true,
      tension: 0.4,
      borderWidth: 3,
      pointRadius: 4,
      pointHoverRadius: 6,
      pointBackgroundColor: "rgba(102, 126, 234, 1)",
      pointBorderColor: '#fff',
      pointBorderWidth: 2
    }, {
      label: "Memory Usage (%)",
      data: fullMemData.slice(-dataPointLimit),
      borderColor: "rgba(245, 87, 108, 1)",
      backgroundColor: "rgba(245, 87, 108, 0.1)",
      fill: true,
      tension: 0.4,
      borderWidth: 3,
      pointRadius: 4,
      pointHoverRadius: 6,
      pointBackgroundColor: "rgba(245, 87, 108, 1)",
      pointBorderColor: '#fff',
      pointBorderWidth: 2
    }];

    var firstDataIndex = limitedLabels.length;
    datasets.forEach(function(dataset) {
      var firstValueIndex = dataset.data.findIndex(function(value) { return value !== null && value !== undefined; });
      if (firstValueIndex !== -1 && firstValueIndex < firstDataIndex) {
        firstDataIndex = firstValueIndex;
      }
    });

    if (firstDataIndex > 0 && firstDataIndex < limitedLabels.length) {
      limitedLabels = limitedLabels.slice(firstDataIndex);
      datasets = datasets.map(function(dataset) {
        return Object.assign({}, dataset, {
          data: dataset.data.slice(firstDataIndex)
        });
      });
    }

    return { labels: limitedLabels, datasets: datasets };
  }

  function updateSystemMonitor(cpuSeries, memorySeries) {
    var cpuValueNode = document.getElementById("cpuUsageValue");
    var memoryValueNode = document.getElementById("memoryUsageValue");
    var cpuBar = document.getElementById("cpuUsageBar");
    var memoryBar = document.getElementById("memoryUsageBar");

    if (cpuValueNode) {
      var cpuValue = cpuSeries.length ? cpuSeries[cpuSeries.length - 1] : null;
      if (cpuValue === null || typeof cpuValue === 'undefined' || isNaN(cpuValue)) {
        cpuValueNode.textContent = '--';
        if (cpuBar) { cpuBar.style.width = '0%'; }
      } else {
        var clampedCpu = Math.max(0, Math.min(100, cpuValue));
        cpuValueNode.textContent = clampedCpu.toFixed(2);
        if (cpuBar) { cpuBar.style.width = clampedCpu.toFixed(2) + '%'; }
      }
    }

    if (memoryValueNode) {
      var memoryValue = memorySeries.length ? memorySeries[memorySeries.length - 1] : null;
      if (memoryValue === null || typeof memoryValue === 'undefined' || isNaN(memoryValue)) {
        memoryValueNode.textContent = '--';
        if (memoryBar) { memoryBar.style.width = '0%'; }
      } else {
        var clampedMemory = Math.max(0, Math.min(100, memoryValue));
        memoryValueNode.textContent = clampedMemory.toFixed(2);
        if (memoryBar) { memoryBar.style.width = clampedMemory.toFixed(2) + '%'; }
      }
    }
  }

  function initializeCharts() {
    var ctx1 = document.getElementById("durationChart").getContext("2d");
    var initialDurationLimit = durationSlider ? parseInt(durationSlider.value) : 30;
    var durationInitialData = buildDurationData(initialDurationLimit);
    durationChart = new Chart(ctx1, {
      type: "line",
      data: durationInitialData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 750, easing: 'easeInOutQuart' },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: "Duration (seconds)", font: { size: 14, weight: 'bold' } },
            grid: { color: 'rgba(0, 0, 0, 0.05)' }
          },
          x: {
            type: 'category',
            position: 'bottom',
            offset: false,
            ticks: { align: 'start' },
            title: { display: true, text: "Workflow Count", font: { size: 14, weight: 'bold' } },
            grid: { color: 'rgba(0, 0, 0, 0.05)', offset: false }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 15,
              font: { size: 12, weight: '600' }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 13 },
            cornerRadius: 8
          },
          zoom: {
            pan: { enabled: true, mode: 'x', speed: 10, threshold: 10 },
            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
          }
        }
      }
    });

    var ctx2 = document.getElementById("cpuMemChart").getContext("2d");
    var aggregated = computeAggregatedSeries();
    var initialResourceLimit = resourcesSlider ? parseInt(resourcesSlider.value) : 30;
    var resourceInitialData = buildResourceData(initialResourceLimit, aggregated.aggregatedCPU, aggregated.hostMemory);
    cpuMemChart = new Chart(ctx2, {
      type: "line",
      data: resourceInitialData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 750, easing: 'easeInOutQuart' },
        scales: {
          x: {
            type: 'category',
            position: 'bottom',
            offset: false,
            ticks: { align: 'start' },
            title: { display: true, text: "Time (seconds)", font: { size: 14, weight: 'bold' } },
            grid: { color: 'rgba(0, 0, 0, 0.05)', offset: false }
          },
          y: {
            beginAtZero: true,
            max: 100,
            title: { display: true, text: "Usage (%)", font: { size: 14, weight: 'bold' } },
            grid: { color: 'rgba(0, 0, 0, 0.05)' }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 15,
              font: { size: 12, weight: '600' }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 13 },
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
              }
            }
          },
          zoom: {
            pan: { enabled: true, mode: 'x', speed: 10, threshold: 10 },
            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
          }
        }
      }
    });

    updateSystemMonitor(aggregated.aggregatedCPU, aggregated.hostMemory);
  }

  function updateCharts() {
    if (!durationChart || !cpuMemChart) {
      return;
    }
    var durationLimit = durationSlider ? parseInt(durationSlider.value) : 30;
    var durationData = buildDurationData(durationLimit);
    durationChart.data.labels = durationData.labels;
    durationChart.data.datasets = durationData.datasets;
    durationChart.update();

    var aggregated = computeAggregatedSeries();
    var resourceLimit = resourcesSlider ? parseInt(resourcesSlider.value) : 30;
    var resourceData = buildResourceData(resourceLimit, aggregated.aggregatedCPU, aggregated.hostMemory);
    cpuMemChart.data.labels = resourceData.labels;
    cpuMemChart.data.datasets = resourceData.datasets;
    cpuMemChart.update();
    updateSystemMonitor(aggregated.aggregatedCPU, aggregated.hostMemory);
  }

  function renderProcessIntelligenceTable(metrics) {
    var pidInfoContainer = document.getElementById("pidParamsContainerOnDashboard");
    if (!pidInfoContainer) {
      return;
    }
    processMetadataByPid = {};
    pidInfoContainer.innerHTML = "";
    var table = document.createElement("table");
    table.classList.add("table", "table-hover");
    var thead = document.createElement("thead");
    thead.innerHTML = `
      <tr>
        <th><i class="fas fa-bars"></i> Actions</th>
        <th><i class="fas fa-hashtag"></i> PID</th>
        <th><i class="fas fa-info-circle"></i> Status</th>
        <th><i class="fas fa-hourglass-half"></i> Time Left</th>
        <th><i class="fas fa-spinner"></i> Active</th>
        <th><i class="fas fa-play"></i> Started</th>
        <th><i class="fas fa-check"></i> Completed</th>
        <th><i class="fas fa-times"></i> Failed</th>
        <th><i class="fas fa-clock"></i> Avg Time</th>
        <th><i class="fas fa-cog"></i> Parameters</th>
      </tr>
    `;
    table.appendChild(thead);
    var tbody = document.createElement("tbody");
    metrics.forEach(function(metric) {
      processMetadataByPid[metric.pid] = {
        configPath: metric.configFilePath || "",
        outputPath: metric.outputFilePath || ""
      };
      var durations = metric.durations || [];
      var avgCompletionTime = durations.length ? durations.reduce(function(a, b) { return a + b; }, 0) / durations.length : NaN;
      
      var paramString = (metric.params || '').trim();
      var normalizedParam = paramString === '' ? '-dashboard' : paramString;
      // Determine if this process should have workflow/output buttons
      var hasConfigPath = metric.configFilePath && metric.configFilePath.trim() !== '';
      var hasOutputPath = metric.outputFilePath && metric.outputFilePath.trim() !== '';
      var showWorkflowButton = hasConfigPath && normalizedParam !== '-dashboard';
      
      // Build action icons conditionally
      var actionIcons = '';
      if (showWorkflowButton) {
        actionIcons += '<i class="fas fa-file-code action-icon workflow" onclick="showWorkflowModal(' + metric.pid + ')" data-tippy-content="View Workflow JSON"></i>';
      }
      if (hasOutputPath) {
        actionIcons += '<i class="fas fa-desktop action-icon output" onclick="showOutputModal(' + metric.pid + ')" data-tippy-content="Preview Output HTML"></i>';
      }
      actionIcons += '<i class="fas fa-file-alt action-icon logs" onclick="openLogsModal(' + metric.pid + ')" data-tippy-content="View Logs"></i>';
      actionIcons += '<i class="fas fa-skull-crossbones action-icon kill" onclick="confirmKill(' + metric.pid + ', \'' + (metric.params || '-dashboard') + '\')" data-tippy-content="Terminate Process"></i>';
      
      var row = document.createElement("tr");
      row.innerHTML = `
        <td style="text-align: center;">
          ${actionIcons}
        </td>
        <td><strong>${metric.pid}</strong></td>
        <td><span class="badge bg-info">${metric.status || 'Running'}</span></td>
        <td>${(typeof metric.timeLeft !== 'undefined' && metric.timeLeft !== null && metric.timeLeft !== 0) ? '<span class="badge bg-warning text-dark">' + metric.timeLeft + 's</span>' : '<span class="badge bg-secondary">-</span>'}</td>
        <td>${metric.activeWorkflows || '0'}</td>
        <td>${metric.totalWorkflowsStarted || '0'}</td>
        <td><span class="badge bg-success">${metric.totalWorkflowsCompleted || '0'}</span></td>
        <td><span class="badge bg-danger">${metric.totalWorkflowsFailed || '0'}</span></td>
        <td>${isNaN(avgCompletionTime) ? '-' : '<strong>' + avgCompletionTime.toFixed(2) + 's</strong>'}</td>
        <td><code>${metric.params || '-dashboard'}</code></td>
      `;
      tbody.appendChild(row);
    });
    table.appendChild(tbody);
    pidInfoContainer.appendChild(table);
  }

  function updatePidFilterOptions(metrics) {
    if (!pidSelectElement) {
      return;
    }
    var selected = pidSelectElement.value;
    pidSelectElement.innerHTML = '';
    var optionAll = document.createElement("option");
    optionAll.value = "";
    optionAll.text = "All PIDs";
    pidSelectElement.appendChild(optionAll);
    var uniquePIDs = [];
    metrics.forEach(function(metric) {
      if (metric.pid != null && uniquePIDs.indexOf(metric.pid) === -1) {
        uniquePIDs.push(metric.pid);
      }
    });
    uniquePIDs.sort(function(a, b) { return a - b; });
    uniquePIDs.forEach(function(pid) {
      var option = document.createElement("option");
      option.value = pid;
      option.text = pid;
      pidSelectElement.appendChild(option);
    });
    if (selected && uniquePIDs.indexOf(parseInt(selected)) !== -1) {
      pidSelectElement.value = selected;
    } else {
      pidSelectElement.value = "";
    }
  }

  function showWorkflowModal(pid) {
    if (!workflowModalElement) {
      return;
    }
    var metadata = processMetadataByPid[pid] || {};
    if (workflowModalPathElement) {
      workflowModalPathElement.textContent = metadata.configPath || 'Path unavailable';
    }
    if (workflowModalContentElement) {
      workflowModalContentElement.textContent = 'Loading workflow...';
    }
    var modalInstance = new bootstrap.Modal(workflowModalElement);
    modalInstance.show();
    if (!metadata.configPath) {
      if (workflowModalContentElement) {
        workflowModalContentElement.textContent = 'Configuration path is missing for PID ' + pid + '.';
      }
      return;
    }
    fetch('/dashboard/workflow?pid=' + encodeURIComponent(pid), { cache: 'no-store' })
      .then(function(response) {
        if (!response.ok) {
          return response.text().then(function(body) {
            throw new Error(body || response.statusText || 'Unable to load workflow');
          });
        }
        return response.text();
      })
      .then(function(text) {
        var formatted = text;
        try {
          var parsed = JSON.parse(text);
          formatted = JSON.stringify(parsed, null, 2);
        } catch (error) {
          // Keep raw text if parsing fails
        }
        if (workflowModalContentElement) {
          workflowModalContentElement.textContent = formatted;
        }
      })
      .catch(function(err) {
        if (workflowModalContentElement) {
          workflowModalContentElement.textContent = 'Unable to load workflow: ' + err.message;
        }
      });
  }

  function showOutputModal(pid) {
    if (!outputModalElement) {
      return;
    }
    outputModalCurrentPid = pid;
    var metadata = processMetadataByPid[pid] || {};
    if (outputModalPathElement) {
      outputModalPathElement.textContent = metadata.outputPath || 'Path unavailable';
    }
    if (outputModalStatusElement) {
      outputModalStatusElement.textContent = 'Loading output...';
    }
    if (outputModalRefreshInterval) {
      clearInterval(outputModalRefreshInterval);
      outputModalRefreshInterval = null;
    }
    // Reset to default auto-refresh state
    outputModalAutoRefreshEnabled = true;
    updateOutputRefreshUI();
    
    var modalInstance = new bootstrap.Modal(outputModalElement);
    modalInstance.show();
    if (!metadata.outputPath) {
      if (outputModalStatusElement) {
        outputModalStatusElement.textContent = 'No output file configured for PID ' + pid + '.';
      }
      return;
    }
    refreshOutputModal(pid);
    startOutputModalAutoRefresh(pid);
    outputModalElement.addEventListener('hidden.bs.modal', function cleanup() {
      if (outputModalRefreshInterval) {
        clearInterval(outputModalRefreshInterval);
        outputModalRefreshInterval = null;
      }
      outputModalCurrentPid = null;
    }, { once: true });
  }

  function startOutputModalAutoRefresh(pid) {
    if (outputModalRefreshInterval) {
      clearInterval(outputModalRefreshInterval);
    }
    if (outputModalAutoRefreshEnabled) {
      outputModalRefreshInterval = setInterval(function() {
        refreshOutputModal(pid);
      }, outputModalRefreshIntervalMs);
    }
  }

  function refreshOutputModal(pid) {
    if (!outputPreviewFrame) {
      return;
    }
    fetch('/dashboard/output?pid=' + encodeURIComponent(pid), { cache: 'no-store' })
      .then(function(response) {
        if (!response.ok) {
          return response.text().then(function(body) {
            throw new Error(body || response.statusText || 'Unable to load output preview');
          });
        }
        return response.text();
      })
      .then(function(html) {
        if (outputPreviewFrame) {
          outputPreviewFrame.srcdoc = html;
        }
        if (outputModalStatusElement) {
          outputModalStatusElement.textContent = 'Updated ' + new Date().toLocaleTimeString();
        }
      })
      .catch(function(err) {
        if (outputModalStatusElement) {
          outputModalStatusElement.textContent = 'Error loading output: ' + err.message;
        }
      });
  }

  function toggleOutputAutoRefresh() {
    outputModalAutoRefreshEnabled = !outputModalAutoRefreshEnabled;
    updateOutputRefreshUI();
    if (outputModalCurrentPid) {
      startOutputModalAutoRefresh(outputModalCurrentPid);
    }
  }

  function updateOutputRefreshInterval() {
    var selectElement = document.getElementById('outputRefreshInterval');
    if (selectElement) {
      outputModalRefreshIntervalMs = parseInt(selectElement.value);
      if (outputModalCurrentPid && outputModalAutoRefreshEnabled) {
        startOutputModalAutoRefresh(outputModalCurrentPid);
      }
      updateOutputRefreshUI();
    }
  }

  function updateOutputRefreshUI() {
    var toggleButton = document.getElementById('outputRefreshToggle');
    var icon = document.getElementById('outputRefreshIcon');
    var statusElement = document.getElementById('outputModalStatus');
    var selectElement = document.getElementById('outputRefreshInterval');
    
    if (toggleButton && icon) {
      if (outputModalAutoRefreshEnabled) {
        toggleButton.classList.remove('btn-outline-success');
        toggleButton.classList.add('btn-success');
        icon.classList.remove('fa-play');
        icon.classList.add('fa-pause');
        toggleButton.title = 'Pause auto-refresh';
      } else {
        toggleButton.classList.remove('btn-success');
        toggleButton.classList.add('btn-outline-success');
        icon.classList.remove('fa-pause');
        icon.classList.add('fa-play');
        toggleButton.title = 'Resume auto-refresh';
      }
    }
    
    if (statusElement) {
      var intervalSeconds = outputModalRefreshIntervalMs / 1000;
      if (outputModalAutoRefreshEnabled) {
        statusElement.textContent = 'Auto-refresh every ' + intervalSeconds + ' seconds';
      } else {
        statusElement.textContent = 'Auto-refresh paused';
      }
    }
  }

  function refreshDashboardData(showIndicator) {
    if (showIndicator) {
      triggerRefreshIndicator();
    }
    return fetch('/dashboard/data')
      .then(function(response) {
        if (!response.ok) {
          throw new Error('Failed to refresh dashboard data');
        }
        return response.json();
      })
      .then(function(payload) {
        if (!payload) {
          return;
        }
        metricsData = payload.extendedMetrics || [];
        updateHeaderMetrics(payload.aggregatedMetrics);
        renderProcessIntelligenceTable(metricsData);
        updatePidFilterOptions(metricsData);
        updateCharts();
        updateRefreshTimestamp(payload.timestamp || Date.now() / 1000);
      })
      .catch(function(error) {
        console.error("Dashboard refresh failed:", error);
      });
  }

  document.addEventListener('DOMContentLoaded', function() {
    durationSlider = document.getElementById('durationDataPoints');
    resourcesSlider = document.getElementById('resourcesDataPoints');
    refreshIndicatorElement = document.getElementById('refreshIndicator');
    refreshTimestampElement = document.getElementById('refreshTimestamp');
    refreshStatusElement = document.getElementById('refreshStatus');
    pidSelectElement = document.getElementById('pidFilter');
    workflowModalElement = document.getElementById('workflowModal');
    workflowModalContentElement = document.getElementById('workflowModalContent');
    workflowModalPathElement = document.getElementById('workflowModalPath');
    outputModalElement = document.getElementById('outputModal');
    outputPreviewFrame = document.getElementById('outputPreviewFrame');
    outputModalStatusElement = document.getElementById('outputModalStatus');
    outputModalPathElement = document.getElementById('outputModalPath');

    if (durationSlider) {
      document.getElementById('durationDataPointsValue').textContent = durationSlider.value;
      durationSlider.addEventListener('input', function() {
        document.getElementById('durationDataPointsValue').textContent = durationSlider.value;
        updateCharts();
      });
    }
    if (resourcesSlider) {
      document.getElementById('resourcesDataPointsValue').textContent = resourcesSlider.value;
      resourcesSlider.addEventListener('input', function() {
        document.getElementById('resourcesDataPointsValue').textContent = resourcesSlider.value;
        updateCharts();
      });
    }

    initializeCharts();
    renderProcessIntelligenceTable(metricsData);
    updatePidFilterOptions(metricsData);
    updateRefreshTimestamp(Date.now() / 1000);

    if (pidSelectElement) {
      pidSelectElement.addEventListener('change', function() {
        loadLogs();
      });
    }

    var modalElements = document.querySelectorAll('.modal');
    modalElements.forEach(function(modalEl) {
      modalEl.addEventListener('show.bs.modal', function() {
        modalOpenCount++;
        pauseAutoRefreshForModal();
      });
      modalEl.addEventListener('hidden.bs.modal', function() {
        modalOpenCount = Math.max(0, modalOpenCount - 1);
        resumeAutoRefreshAfterModal();
      });
    });

    var consoleModal = document.getElementById("consoleModal");
    if (consoleModal) {
      consoleModal.addEventListener('show.bs.modal', function() {
        loadLogs();
      });
    }

    var loadLogsButton = document.getElementById("loadLogs");
    if (loadLogsButton) {
      loadLogsButton.addEventListener("click", function() { loadLogs(); });
    }

    var autoRefreshLogsCheckbox = document.getElementById("autoRefreshLogsCheckbox");
    var refreshIntervalSelect = document.getElementById("logsRefreshInterval");
    var refreshIntervalId2 = null;
    function startLogsAutoRefresh(interval) {
      if (!refreshIntervalId2) {
        refreshIntervalId2 = setInterval(loadLogs, interval * 1000);
      }
    }
    function stopLogsAutoRefresh() {
      if (refreshIntervalId2) {
        clearInterval(refreshIntervalId2);
        refreshIntervalId2 = null;
      }
    }
    if (autoRefreshLogsCheckbox) {
      autoRefreshLogsCheckbox.addEventListener("change", function() {
        if (this.checked && refreshIntervalSelect) {
          startLogsAutoRefresh(parseInt(refreshIntervalSelect.value));
        } else {
          stopLogsAutoRefresh();
        }
      });
    }
    if (refreshIntervalSelect) {
      refreshIntervalSelect.addEventListener("change", function() {
        if (autoRefreshLogsCheckbox && autoRefreshLogsCheckbox.checked) {
          stopLogsAutoRefresh();
          startLogsAutoRefresh(parseInt(this.value));
        }
      });
    }

    if (autoRefreshEnabled && !autoRefreshPausedByModal) {
      startAutoRefresh();
    }
  });

  function loadLogs() {
    var pid = pidSelectElement ? pidSelectElement.value : (document.getElementById("pidFilter") ? document.getElementById("pidFilter").value : "");
    var url = "/console";
    if (pid) {
      url += "?pid=" + encodeURIComponent(pid);
    }

    fetch(url)
      .then(function(response) { return response.json(); })
      .then(function(data) {
        var container = document.getElementById("logsContainer");
        if (!container) {
          return;
        }
        container.innerHTML = "";

        if (!data || data.length === 0) {
          container.innerHTML = "<p>No logs found.</p>";
          return;
        }

        const pidParamsMap = {};
        var table = document.createElement("table");
        table.classList.add("table", "table-dark", "table-striped", "table-sm");
        var thead = document.createElement("thead");
        thead.innerHTML = `
          <tr>
            <th style="width: 180px;">Time</th>
            <th style="width: 60px;">PID</th>
            <th>Log</th>
          </tr>
        `;
        table.appendChild(thead);
        var tbody = document.createElement("tbody");

        data.forEach(function(entry) {
          const entryPid = entry.pid;
          const param = entry.parameters;
          if (!pidParamsMap[entryPid]) {
            pidParamsMap[entryPid] = new Set();
          }
          pidParamsMap[entryPid].add(param);
          var row = document.createElement("tr");
          var timestamp = new Date(entry.timestamp).toLocaleString();
          row.innerHTML = `
            <td style="color: green;">${timestamp}</td>
            <td style="color: LightGreen;">${entryPid}</td>
            <td style="color: white;">${entry.log}</td>
          `;
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        container.appendChild(table);

        const containerParams = document.getElementById("pidParamsContainer");
        if (containerParams) {
          containerParams.innerHTML = "";
          const renderParamsRow = function(pidValue, paramsSet) {
            const entries = Array.from(paramsSet || []);
            const paramString = entries.length ? entries.join(", ") : "-";
            return `
              <div class="pid-param-row">
                <span class="badge bg-dark text-light pid-badge"><span class="pid-label">PID</span><span class="pid-value">${pidValue}</span></span>
                <span class="badge bg-secondary text-dark param-badge"><span class="param-label">Parameters</span><span class="param-text">${paramString}</span></span>
              </div>`;
          };
          const selectedPid = pidSelectElement ? pidSelectElement.value : "";
          if (!selectedPid) {
            Object.entries(pidParamsMap).forEach(function(pair) {
              containerParams.innerHTML += renderParamsRow(pair[0], pair[1]);
            });
          } else {
            const paramsSet = pidParamsMap[selectedPid];
            if (paramsSet) {
              containerParams.innerHTML = renderParamsRow(selectedPid, paramsSet);
            } else {
              containerParams.innerHTML = `<p>No logs found for PID ${selectedPid}.</p>`;
            }
          }
        }
      })
      .catch(function(err) {
        console.error("Error loading logs:", err);
      });
  }

  function openLogsModal(pid) {
    var pidFilter = document.getElementById("pidFilter");
    pidFilter.value = pid;
    var consoleModal = new bootstrap.Modal(document.getElementById("consoleModal"));
    consoleModal.show();
    loadLogs();
  }

  var loadedConfigData = null;
  var configFileInputControl = document.getElementById("configFileInput");
  if (configFileInputControl) {
    configFileInputControl.addEventListener("change", handleConfigFileSelection);
  }

  function handleConfigFileSelection(event) {
    resetConfigDetails();
    var file = event && event.target && event.target.files ? event.target.files[0] : null;
    if (!file) {
      return;
    }
    var reader = new FileReader();
    reader.onload = function(loadEvent) {
      var text = loadEvent.target ? loadEvent.target.result : "";
      var preview = document.getElementById("configPreview");
      if (preview) {
        preview.textContent = typeof text === "string" ? text : "";
      }
      var wrapper = document.getElementById("configDetailsWrapper");
      if (wrapper) {
        wrapper.classList.remove("d-none");
      }
      try {
        var parsed = JSON.parse(text);
        loadedConfigData = parsed;
        showConfigMetadata(parsed);
        setOverrideValue("overrideHostInput", parsed && parsed.Host !== undefined ? parsed.Host : "");
        setOverrideValue("overridePortInput", parsed && parsed.Port !== undefined ? parsed.Port : "");
        setOverrideValue("overrideOutputFilePathInput", parsed && parsed.OutputFilePath !== undefined ? parsed.OutputFilePath : "");
        setOverrideValue("overrideRampUpBatchSizeInput", parsed && parsed.RampUpBatchSize !== undefined ? parsed.RampUpBatchSize : "");
        setOverrideValue("overrideRampUpDelayInput", parsed && parsed.RampUpDelay !== undefined ? parsed.RampUpDelay : "");
        toggleOverridesFieldset(true);
      } catch (err) {
        var metadataList = document.getElementById("configMetadata");
        if (metadataList) {
          metadataList.innerHTML = '<dt class="col-12 text-danger">Failed to read configuration: ' + escapeHtml(err && err.message ? err.message : "Unknown error") + "</dt>";
        }
        setOverrideValue("overrideHostInput", "");
        setOverrideValue("overridePortInput", "");
        setOverrideValue("overrideOutputFilePathInput", "");
        setOverrideValue("overrideRampUpBatchSizeInput", "");
        setOverrideValue("overrideRampUpDelayInput", "");
        toggleOverridesFieldset(false);
      }
    };
    reader.onerror = function() {
      var wrapper = document.getElementById("configDetailsWrapper");
      if (wrapper) {
        wrapper.classList.remove("d-none");
      }
      var metadataList = document.getElementById("configMetadata");
      if (metadataList) {
        metadataList.innerHTML = '<dt class="col-12 text-danger">Failed to load configuration file.</dt>';
      }
      loadedConfigData = null;
      toggleOverridesFieldset(false);
    };
    reader.readAsText(file);
  }

  function showConfigMetadata(configData) {
    var metadataList = document.getElementById("configMetadata");
    if (!metadataList) {
      return;
    }
    var items = "";
    items += buildMetadataRow("Host", configData ? configData.Host : "");
    items += buildMetadataRow("Port", configData ? configData.Port : "");
    items += buildMetadataRow("Output File", configData ? configData.OutputFilePath : "");
    items += buildMetadataRow("Ramp Up Batch Size", configData ? configData.RampUpBatchSize : "");
    items += buildMetadataRow("Ramp Up Delay", configData ? configData.RampUpDelay : "");
    metadataList.innerHTML = items;
  }

  function buildMetadataRow(label, value) {
    var safeValue = value === undefined || value === null || value === "" ? "-" : value;
    return '<dt class="col-sm-5">' + escapeHtml(label) + '</dt><dd class="col-sm-7 text-break">' + escapeHtml(safeValue) + "</dd>";
  }

  function setOverrideValue(elementId, value) {
    var input = document.getElementById(elementId);
    if (!input) {
      return;
    }
    if (value === undefined || value === null) {
      input.value = "";
      return;
    }
    input.value = value;
  }

  function toggleOverridesFieldset(show) {
    var fieldset = document.getElementById("overridesFieldset");
    if (!fieldset) {
      return;
    }
    if (show) {
      fieldset.classList.remove("d-none");
    } else {
      fieldset.classList.add("d-none");
    }
  }

  function resetConfigDetails() {
    var wrapper = document.getElementById("configDetailsWrapper");
    if (wrapper) {
      wrapper.classList.add("d-none");
    }
    var metadataList = document.getElementById("configMetadata");
    if (metadataList) {
      metadataList.innerHTML = "";
    }
    var preview = document.getElementById("configPreview");
    if (preview) {
      preview.textContent = "";
    }
    loadedConfigData = null;
    setOverrideValue("overrideHostInput", "");
    setOverrideValue("overridePortInput", "");
    setOverrideValue("overrideOutputFilePathInput", "");
    setOverrideValue("overrideRampUpBatchSizeInput", "");
    setOverrideValue("overrideRampUpDelayInput", "");
    toggleOverridesFieldset(false);
  }

  function escapeHtml(value) {
    if (value === undefined || value === null) {
      return "";
    }
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function appendOverrideField(formData, elementId, fieldName) {
    var input = document.getElementById(elementId);
    if (!input) {
      return;
    }
    var value = typeof input.value === "string" ? input.value.trim() : "";
    if (value !== "") {
      formData.append(fieldName, value);
    }
  }

  function testWorkflowConnection() {
    var hostInput = document.getElementById('overrideHostInput');
    var portInput = document.getElementById('overridePortInput');
    var rawHost = hostInput && hostInput.value ? hostInput.value.trim() : "";
    var rawPort = portInput && portInput.value ? portInput.value.trim() : "";

    var hostToUse = rawHost !== "" ? rawHost : (loadedConfigData && loadedConfigData.Host ? String(loadedConfigData.Host) : "");
    var portSource = rawPort !== "" ? rawPort : (loadedConfigData && typeof loadedConfigData.Port !== 'undefined' ? String(loadedConfigData.Port) : "");

    if (hostToUse === "") {
      toastr.error('Host is required to test the connection. Provide an override or load a configuration file.');
      return;
    }
    if (portSource === "") {
      toastr.error('Port is required to test the connection. Provide an override or load a configuration file.');
      return;
    }

    var portNumber = Number(portSource);
    if (!Number.isInteger(portNumber) || portNumber <= 0) {
      toastr.error('Port must be a positive integer.');
      return;
    }

    var button = document.getElementById('testConnectionButton');
    if (button) {
      button.disabled = true;
      button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Testing...';
    }

    fetch('/test-connection', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ host: hostToUse, port: portNumber })
    })
      .then(function(response) {
        if (!response.ok) {
          return response.json().then(function(data) {
            var message = data && data.message ? data.message : 'Failed to test connection.';
            throw new Error(message);
          }).catch(function(err) {
            throw err instanceof Error ? err : new Error('Failed to test connection.');
          });
        }
        return response.json();
      })
      .then(function(data) {
        toastr.success(data && data.message ? data.message : 'Connection successful.');
      })
      .catch(function(error) {
        toastr.error(error && error.message ? error.message : 'Unable to connect to host.');
      })
      .finally(function() {
        if (button) {
          button.disabled = false;
          button.innerHTML = '<i class="fas fa-plug me-2"></i>Test Connection';
        }
      });
  }

  function start3270ConnectProcess() {
    var errorsDiv = document.getElementById('processErrors');
    errorsDiv.innerHTML = '';
    var formElem = document.getElementById('startProcessForm');
    
    // Check if form is valid using form.checkValidity()
    if (!formElem.checkValidity()) {
      errorsDiv.innerHTML = '<div class="alert alert-danger">Please complete all required fields.</div>';
      return;
    }
    
    var configFileInput = document.getElementById('configFileInput');
    // Additionally trap error if configuration file is not supplied
    if (!configFileInput.files || configFileInput.files.length === 0) {
      errorsDiv.innerHTML = '<div class="alert alert-danger">Configuration file is required.</div>';
      return;
    }
    
    // All required fields provided; build FormData manually
    var formData = new FormData();
    formData.append("configFile", configFileInput.files[0]);

    var injectionConfigInput = document.getElementById('injectionConfigInput');
    if (injectionConfigInput.files && injectionConfigInput.files.length > 0) {
      formData.append("injectionConfig", injectionConfigInput.files[0]);
    }

    formData.append("concurrent", document.getElementById('concurrentInput').value);
    formData.append("runtime", document.getElementById('runtimeInput').value);
    formData.append("startPort", document.getElementById('startPortInput').value);
    formData.append("headless", document.getElementById('headlessInput').checked ? "on" : "off");
    var tokenInput = document.getElementById('tokenInput');
    if (tokenInput && tokenInput.value.trim() !== "") {
      formData.append("token", tokenInput.value.trim());
    }
    appendOverrideField(formData, 'overrideHostInput', 'overrideHost');
    appendOverrideField(formData, 'overridePortInput', 'overridePort');
    appendOverrideField(formData, 'overrideOutputFilePathInput', 'overrideOutputFilePath');
    appendOverrideField(formData, 'overrideRampUpBatchSizeInput', 'overrideRampUpBatchSize');
    appendOverrideField(formData, 'overrideRampUpDelayInput', 'overrideRampUpDelay');
  
    fetch('/start-process', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        toastr.success('Process started successfully!');
        var modalEl = document.getElementById("startProcessModal");
        var modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) {
          modalInstance.hide();
          setTimeout(function() {
          window.location.href = window.location.href;
          }, 5000);
        }
      } else {
        return response.text().then((text) => {
          toastr.error(`Failed to start process: ${String(text)}`);
        });
      }
    })
    .catch(error => {
      console.error('Error starting process:', error);
      toastr.error(`An error occurred while starting the process: ${String(error.message)}`);
    });
  }

  // New function to handle starting the sample 3270 App
  function start3270App() {
    var errorsDiv = document.getElementById('appProcessErrors');
    errorsDiv.innerHTML = '';
    var formElem = document.getElementById('startAppForm');
    if (!formElem.checkValidity()) {
      errorsDiv.innerHTML = '<div class="alert alert-danger">Please complete all required fields.</div>';
      return;
    }
    var runApp = document.getElementById('runAppSelect').value;
    var runAppPort = document.getElementById('runAppPortInput').value;
    // Build FormData with runApp params
    var formData = new FormData();
    formData.append("runApp", runApp);
    formData.append("runAppPort", runAppPort);
  
    fetch('/start-process', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        toastr.success('Sample app started successfully!');
      } else {
        return response.text().then((text) => {
          toastr.error(`Failed to start sample app: ${String(text)}`);
        });
      }
    })
    .catch(error => {
      console.error('Error starting sample app:', error);
      toastr.error(`An error occurred while starting the sample app: ${String(error.message)}`);
    });
    
    var modalEl = document.getElementById("startAppModal");
    var modalInstance = bootstrap.Modal.getInstance(modalEl);
    if (modalInstance) {
      modalInstance.hide();
    }
    setTimeout(function() {
      window.location.href = window.location.href;
    }, 5000);
  }

  // Create a mapping for extended metrics keyed by PID
  var extendedMetrics = {
    {{range .ExtendedMetricsList}}
      "{{.PID}}": {
        status: "{{.Status}}",
        timeLeft: "{{.TimeLeft}}"
      },
    {{end}}
  };

  document.addEventListener('DOMContentLoaded', function () {
    // Initialize default tooltips with an offset
    tippy('[data-tippy-content]', {
      placement: 'top',
      animation: 'fade',
      theme: 'light',
      popperOptions: {
        modifiers: [ {
          name: 'offset',
          options: { offset: [0, 8] }
        } ]
      }
    });
    // Specific settings for auto refresh toggle tooltip
    tippy('#autoRefreshToggle', {
      content: document.querySelector('#autoRefreshToggle').getAttribute('data-tippy-content') || "Enable or disable automatic page refresh.",
      placement: 'right',
      animation: 'fade',
      theme: 'light',
      popperOptions: {
        modifiers: [ {
          name: 'offset',
          options: { offset: [20, 0] }
        } ]
      }
    });
    // Specific settings for refresh period select tooltip
    tippy('#refreshPeriodSelect', {
      content: document.querySelector('#refreshPeriodSelect').getAttribute('data-tippy-content') || "Set the interval for automatic page refresh in seconds.",
      placement: 'right',
      animation: 'fade',
      theme: 'light',
      popperOptions: {
        modifiers: [ {
          name: 'offset',
          options: { offset: [20, 0] }
        } ]
      }
    });
  });

  // Set toastr options
  toastr.options = {
    "closeButton": false,
    "debug": false,
    "newestOnTop": true,
    "progressBar": true,
    "positionClass": "toast-top-right",
    "preventDuplicates": false,
    "onclick": null,
    "showDuration": "300",
    "hideDuration": "1000",
    "timeOut": "5000",
    "extendedTimeOut": "1000",
    "showEasing": "swing",
    "hideEasing": "linear",
    "showMethod": "fadeIn",
    "hideMethod": "fadeOut"
  };

  function confirmKill(pid, params) {
    document.getElementById("killDetails").innerHTML = `
      <p>Are you sure you want to kill the following process?</p>
      <div class="alert alert-info">
      <strong>PID:</strong> ${pid}<br>
      <strong>Parameters:</strong> ${params}
      </div>
    `;
    var killModal = new bootstrap.Modal(document.getElementById("killModal"));
    document.getElementById("confirmKillBtn").onclick = function() {
      killProcess(pid);
    };
    killModal.show();
  }

  function killProcess(pid) {
    fetch('/kill?pid=' + encodeURIComponent(pid), { method: 'POST' })
      .then(response => {
        return response.text().then(text => {
          if (response.ok) {
            toastr.success(text);
          } else {
            toastr.error(text);
          }
        });
      });
    var killModal = document.getElementById("killModal");
    var modalInstance = document.getElementById("killModal");
    var modalInstance = bootstrap.Modal.getInstance(killModal);
    if (modalInstance) {
        modalInstance.hide();
    }
    setTimeout(function() {
      window.location.href = window.location.href;
    }, 5000);
  }

  document.getElementById("closeModal").onclick = function() {
    var killModal = document.getElementById("killModal");
    var modalInstance = bootstrap.Modal.getInstance(killModal);
    if (modalInstance) {
        modalInstance.hide();
    }
    setTimeout(function() {
      window.location.href = window.location.href;
    }, 5000);
  };

  // Functions for maximizing and restoring console modal
  function maximizeConsoleModal() {
    var modalDialog = document.getElementById("consoleModalDialog");
    modalDialog.classList.add("modal-maximized");
    document.getElementById("maximizeConsoleBtn").style.display = "none";
    document.getElementById("restoreConsoleBtn").style.display = "inline-block";
  }

  function restoreConsoleModal() {
    var modalDialog = document.getElementById("consoleModalDialog");
    modalDialog.classList.remove("modal-maximized");
    document.getElementById("maximizeConsoleBtn").style.display = "inline-block";
    document.getElementById("restoreConsoleBtn").style.display = "none";
  }
</script>
</body>
</html>
