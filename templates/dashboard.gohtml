<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>3270Connect Dashboard</title>
  <link rel="shortcut icon" href="/static/images/logo.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.2.0"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- added jQuery dependency -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css">
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --info-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      --dark-bg: #1a1a2e;
      --card-bg: #ffffff;
      --text-primary: #2d3748;
      --text-secondary: #718096;
      --border-radius: 16px;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
    }

    body { 
      padding-top: 70px; 
      padding-bottom: 70px; 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-primary);
    }

    /* Modern Navbar */
    .navbar {
      background: var(--primary-gradient) !important;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .navbar-brand {
      font-weight: 700;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: transform 0.3s ease;
    }

    .navbar-brand:hover {
      transform: scale(1.05);
    }

    .navbar-brand img {
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
    }

    /* Modern Buttons */
    .btn {
      border-radius: 12px;
      padding: 10px 24px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      box-shadow: var(--shadow-sm);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn-primary {
      background: var(--primary-gradient);
      color: white;
    }

    .btn-success {
      background: var(--success-gradient);
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #868f96 0%, #596164 100%);
      color: white;
    }

    .btn-light {
      background: white;
      color: var(--text-primary);
    }

    .btn-danger {
      background: var(--secondary-gradient);
      color: white;
    }

    /* Hero Section with Gradient */
    .hero-section {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      padding: 40px;
      margin-bottom: 32px;
      position: relative;
      overflow: hidden;
    }

    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: var(--primary-gradient);
    }

    .hero-section h1 {
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .hero-section .subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 500;
    }

    /* Modern Metric Cards */
    .metric-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 24px;
      margin: 12px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
      min-width: 200px;
    }

    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .metric-card.active {
      border-left-color: #667eea;
    }

    .metric-card.started {
      border-left-color: #4facfe;
    }

    .metric-card.completed {
      border-left-color: #43e97b;
    }

    .metric-card.failed {
      border-left-color: #f5576c;
    }

    .metric-card h5 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .metric-card .metric-value {
      font-size: 2.5rem;
      font-weight: 800;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
    }

    .metric-card .metric-icon {
      font-size: 2rem;
      opacity: 0.2;
      position: absolute;
      right: 24px;
      top: 24px;
    }

    /* Chart Container */
    .chart-wrapper {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--shadow-md);
      margin-bottom: 24px;
      transition: all 0.3s ease;
    }

    .chart-wrapper:hover {
      box-shadow: var(--shadow-lg);
    }

    .chart-wrapper h3 {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }

    .chart-container { 
      margin: auto; 
      height: 400px; 
      position: relative;
    }

    /* Modern Table Styling */
    .table-wrapper {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--shadow-md);
      margin-top: 24px;
    }

    .table {
      margin-bottom: 0;
    }

    .table thead {
      background: var(--primary-gradient);
      color: white;
    }

    .table thead th {
      border: none;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.85rem;
      padding: 16px;
    }

    .table tbody tr {
      transition: all 0.2s ease;
    }

    .table tbody tr:hover {
      background-color: #f8f9fa;
      transform: scale(1.01);
    }

    .table tbody td {
      padding: 16px;
      vertical-align: middle;
      border-bottom: 1px solid #f0f0f0;
    }

    /* Action Icons */
    .action-icon {
      font-size: 1.2rem;
      cursor: pointer;
      margin: 0 6px;
      transition: all 0.2s ease;
    }

    .action-icon:hover {
      transform: scale(1.2);
    }

    .action-icon.logs {
      color: #4facfe;
    }

    .action-icon.kill {
      color: #f5576c;
    }

    /* Modern Form Controls */
    .form-control, .form-select {
      border-radius: 10px;
      border: 2px solid #e2e8f0;
      padding: 10px 16px;
      transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-check-input:checked {
      background-color: #667eea;
      border-color: #667eea;
    }

    .form-label {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    /* Modern Modal */
    .modal-content {
      border-radius: var(--border-radius);
      border: none;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      background: var(--primary-gradient);
      color: white;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
      border-bottom: none;
      padding: 20px 24px;
    }

    .modal-title {
      font-weight: 700;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      border-top: 1px solid #f0f0f0;
      padding: 20px 24px;
    }

    .btn-close {
      filter: brightness(0) invert(1);
    }

    /* Footer */
    footer {
      background: var(--dark-bg) !important;
      box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
    }

    /* Auto Refresh Toggle */
    .settings-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow-sm);
      margin-top: 24px;
    }

    .form-check-input {
      cursor: pointer;
      width: 48px;
      height: 24px;
    }

    /* Toast Notification */
    #toast-container.toast-top-right {
      top: 80px !important;
      right: 20px;
    }

    .toast {
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
    }

    /* Logs Container */
    #logsContainer {
      background: #1a1a2e !important;
      border-radius: 12px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    }

    /* Badge Styling */
    .badge {
      border-radius: 8px;
      padding: 6px 12px;
      font-weight: 600;
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .metric-card, .chart-wrapper, .table-wrapper {
      animation: fadeInUp 0.5s ease-out;
    }

    /* Loading State */
    .chart-container.loading::after {
      content: 'Loading...';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: 600;
      color: var(--text-secondary);
    }

    /* Responsive Improvements */
    @media (max-width: 768px) {
      .hero-section {
        padding: 24px;
      }

      .metric-card {
        margin: 8px 0;
        min-width: 100%;
      }

      .chart-container {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#">
        <img src="/static/images/logo.png" alt="3270Connect Logo" width="30" class="d-inline-block align-top">
        3270Connect
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item me-2">
            <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#consoleModal" data-tippy-content="Show the Console Logs">
              Console Logs
            </button>
          </li>
          <li class="nav-item">
            <button class="btn btn-light" onclick="location.reload();" data-tippy-content="Refresh the Page">
              <i class="fas fa-sync-alt"></i>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container my-4">
    <div class="hero-section">
      <div class="container-fluid">
        <h1 class="display-4" data-tippy-content="This section displays aggregated metrics for all workflows.">3270Connect Dashboard</h1>
        <p class="subtitle" data-tippy-content="Metrics are grouped by Process ID (PID).">Real-time Workflow Monitoring & Management</p>
        <div class="d-flex flex-wrap justify-content-around mt-4">
          <div class="metric-card active" data-tippy-content="Number of workflows currently running.">
            <i class="fas fa-spinner fa-spin metric-icon"></i>
            <h5>Active Workflows</h5>
            <p class="metric-value">{{.ActiveWorkflows}}</p>
          </div>
          <div class="metric-card started" data-tippy-content="Total number of workflows that have been started.">
            <i class="fas fa-play-circle metric-icon"></i>
            <h5>Total Started</h5>
            <p class="metric-value">{{.TotalWorkflowsStarted}}</p>
          </div>
          <div class="metric-card completed" data-tippy-content="Total number of workflows that have completed successfully.">
            <i class="fas fa-check-circle metric-icon"></i>
            <h5>Completed</h5>
            <p class="metric-value">{{.TotalWorkflowsCompleted}}</p>
          </div>
          <div class="metric-card failed" data-tippy-content="Total number of workflows that have failed.">
            <i class="fas fa-times-circle metric-icon"></i>
            <h5>Failed</h5>
            <p class="metric-value">{{.TotalWorkflowsFailed}}</p>
          </div>
        </div>
        <div class="settings-card">
          <form id="autoRefreshForm" method="get">
            <div class="row align-items-center">
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="autoRefreshToggle" name="autoRefresh" value="true" {{.Checked}} onchange="this.form.submit()">
                  <label class="form-check-label" for="autoRefreshToggle">Auto Refresh</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="d-flex align-items-center gap-2">
                  <label for="refreshPeriodSelect" class="form-label mb-0">Refresh Period:</label>
                  <select class="form-select w-auto" id="refreshPeriodSelect" name="refreshPeriod" onchange="this.form.submit()">
                    <option value="1" {{.Sel1}}>1s</option>
                    <option value="5" {{.Sel5}}>5s</option>
                    <option value="10" {{.Sel10}}>10s</option>
                    <option value="15" {{.Sel15}}>15s</option>
                    <option value="30" {{.Sel30}}>30s</option>
                  </select>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <div class="chart-wrapper" data-tippy-content="This chart shows the duration of workflows over time.">
          <h3><i class="fas fa-clock"></i> Workflow Duration</h3>
          <div class="chart-container">
            <canvas id="durationChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="chart-wrapper" data-tippy-content="This chart shows CPU and memory usage over time.">
          <h3><i class="fas fa-chart-line"></i> System Resources</h3>
          <div class="chart-container">
            <canvas id="cpuMemChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-md-12">
        <div class="table-wrapper">
          <div id="pidParamsContainerOnDashboard">
            <!-- Table for process metrics will be rendered here -->
          </div>
        </div>
      </div>
    </div>
    <div class="text-center mt-4">
      <button class="btn btn-primary btn-lg me-2" data-bs-toggle="modal" data-bs-target="#startProcessModal" data-tippy-content="Click to start a new 3270Connect process.">
        <i class="fas fa-rocket me-2"></i>Start 3270Connect Process
      </button>
      <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#startAppModal" data-tippy-content="Click to start a sample 3270 app.">
        <i class="fas fa-server me-2"></i>Start 3270 App
      </button>
    </div>
  </div>
  <!-- Tooltip for notifications -->
  <div id="tooltipNotification" class="tooltip bs-tooltip-top" role="tooltip" style="position: fixed; top: 10px; right: 10px; z-index: 9999; display: none;">
    <div class="tooltip-arrow"></div>
    <div class="tooltip-inner"></div>
  </div>
  <!-- Modal for Console Logs -->
  <div class="modal fade" id="consoleModal" tabindex="-1" aria-labelledby="consoleModalLabel" style="display: none;">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="consoleModalLabel">Console Logs</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="pidParamsContainer" class="mb-3 p-3 bg-light border rounded"></div>
          <div class="mb-3">
            <label for="pidFilter" class="form-label">Filter by PID</label>
            <select id="pidFilter" class="form-select">
              <!-- Options will be auto populated -->
            </select>
          </div>
          <div class="mb-3 p-3 bg-dark text-success" id="logsContainer" style="max-height:400px; overflow-y:auto; font-family: 'Courier New', Courier, monospace;">
            <!-- Logs will be loaded here -->
          </div>
            <div class="mb-3 p-3 bg-light border rounded">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="autoRefreshLogsCheckbox">
            <label class="form-check-label" for="autoRefreshLogsCheckbox">Auto Refresh</label>
          </div>
            <div class="mt-2">
              <label for="logsRefreshInterval" class="form-label">Refresh Interval (seconds):</label>
              <select class="form-select w-auto" id="logsRefreshInterval">
                <option value="1">1</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
                <option value="30">30</option>
              </select>
            </div>
            </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal for Starting 3270Connect Process -->
  <div class="modal fade" id="startProcessModal" tabindex="-1" aria-labelledby="startProcessModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="startProcessModalLabel">Start 3270Connect Process</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="startProcessForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="configFileInput" class="form-label">Configuration File</label>
              <input type="file" class="form-control" id="configFileInput" name="configFile" accept=".json" required>
            </div>
          <div class="mb-3">
            <label for="injectionConfigInput" class="form-label">Injection Config File (Optional)</label>
            <input type="file" class="form-control" id="injectionConfigInput" name="injectionConfig" accept=".json">
          </div>
            <div class="mb-3">
              <label for="concurrentInput" class="form-label">Concurrent Workflows</label>
              <input type="number" class="form-control" id="concurrentInput" name="concurrent" placeholder="Enter number of concurrent workflows" value="5" required>
            </div>
            <div class="mb-3">
              <label for="runtimeInput" class="form-label">Runtime Duration (seconds)</label>
              <input type="number" class="form-control" id="runtimeInput" name="runtime" placeholder="Enter runtime duration" value="180" required>
            </div>
            <div class="mb-3">
              <label for="startPortInput" class="form-label">Starting Port</label>
              <input type="number" class="form-control" id="startPortInput" name="startPort" placeholder="Enter starting port" value="5000" required>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="headlessInput" name="headless" checked>
              <label class="form-check-label" for="headlessInput">Headless Mode</label>
            </div>
          </form>
          <!-- New error container -->
          <div id="processErrors"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" data-tippy-content="Click to start the 3270Connect process" onclick="start3270ConnectProcess()">Start Process</button>
        </div>
      </div>
    </div>
  </div>
  <!-- New Modal for Starting 3270 App -->
  <div class="modal fade" id="startAppModal" tabindex="-1" aria-labelledby="startAppModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="startAppModalLabel">Start 3270 App</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="startAppForm" novalidate>
            <div class="mb-3">
              <label for="runAppSelect" class="form-label">Select Sample App</label>
              <select class="form-select" id="runAppSelect" name="runApp" required>
                <option value="">Choose...</option>
                <option value="1">Sample App 1</option>
                <option value="2">Sample App 2</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="runAppPortInput" class="form-label">App Port</label>
              <input type="number" class="form-control" id="runAppPortInput" name="runAppPort" placeholder="Enter port" value="3270" required>
            </div>
          </form>
          <!-- New error container for start app modal -->
          <div id="appProcessErrors"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-success" data-tippy-content="Click to start the sample 3270 app" onclick="start3270App()">Start App</button>
        </div>
      </div>
    </div>
  </div>

<!-- Modal for Kill Confirmation -->
<div class="modal fade" id="killModal" tabindex="-1" aria-labelledby="killModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="killModalLabel">Confirm Kill Process</h5>
        <button type="button" id="closeModal" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="killDetails"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirmKillBtn" class="btn btn-danger">Confirm Kill</button>
      </div>
    </div>
  </div>
</div>

  <footer class="bg-dark text-white fixed-bottom">
    <div class="container text-center py-2">
      &copy; {{.Year}} 3270Connect. All rights reserved. v{{.Version }}
    </div>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  var autoRefreshEnabled = {{.AutoRefreshEnabled}};
  var refreshPeriod = {{.RefreshPeriod}};
  var refreshIntervalId = null;
  var autoRefreshPausedByModal = false;
  
  function startAutoRefresh() {
    if (autoRefreshEnabled && !refreshIntervalId && !autoRefreshPausedByModal) {
      refreshIntervalId = setInterval(function() { window.location.reload(); }, parseInt(refreshPeriod) * 1000);
      console.log("Auto refresh started");
    }
  }
  
  function stopAutoRefresh() {
    if (refreshIntervalId) { 
      clearInterval(refreshIntervalId); 
      refreshIntervalId = null; 
      console.log("Auto refresh paused"); 
    }
  }
  
  function handleAutoRefreshToggle() {
    var form = document.getElementById('autoRefreshForm');
    var checkbox = document.getElementById('autoRefreshToggle');
    var url = new URL(window.location.href);
    
    if (checkbox.checked) {
      url.searchParams.set('autoRefresh', 'true');
    } else {
      url.searchParams.set('autoRefresh', 'false');
    }
    
    // Preserve the refresh period
    var refreshPeriodSelect = document.getElementById('refreshPeriodSelect');
    if (refreshPeriodSelect.value) {
      url.searchParams.set('refreshPeriod', refreshPeriodSelect.value);
    }
    
    window.location.href = url.toString();
  }
  
  startAutoRefresh();
  document.addEventListener('DOMContentLoaded', function() {
    var metricsData = JSON.parse('{{.ExtendedJSON}}');
    var maxCount = 0;
    metricsData.forEach(function(metric) { if (metric.durations && metric.durations.length > maxCount) { maxCount = metric.durations.length; } });
    var labels = [];
    for (var i = 0; i < maxCount; i++) { labels.push((i + 1)); }
    
    // Modern gradient color palette
    var colors = [
      'rgba(102, 126, 234, 1)',  // Purple
      'rgba(75, 192, 192, 1)',   // Teal
      'rgba(255, 159, 64, 1)',   // Orange
      'rgba(118, 75, 162, 1)',   // Deep Purple
      'rgba(255, 99, 132, 1)',   // Pink
      'rgba(54, 162, 235, 1)',   // Blue
      'rgba(153, 102, 255, 1)',  // Violet
      'rgba(255, 206, 86, 1)'    // Yellow
    ];
    
    var datasets = [];
    metricsData.forEach(function(metric, index) {
      var data = new Array(maxCount - metric.durations.length).fill(null).concat(metric.durations);
      datasets.push({
        label: "PID " + metric.pid,
        data: data,
        borderColor: colors[index % colors.length],
        backgroundColor: colors[index % colors.length].replace("1)", "0.1)"),
        fill: true,
        tension: 0.4,
        borderWidth: 3,
        pointRadius: 4,
        pointHoverRadius: 6,
        pointBackgroundColor: colors[index % colors.length],
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      });
    });
    
    var ctx1 = document.getElementById("durationChart").getContext("2d");
    new Chart(ctx1, {
      type: "line",
      data: { labels: labels, datasets: datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 750, easing: 'easeInOutQuart' },
        scales: { 
          y: { 
            beginAtZero: true, 
            title: { display: true, text: "Duration (seconds)", font: { size: 14, weight: 'bold' } },
            grid: { color: 'rgba(0, 0, 0, 0.05)' }
          }, 
          x: { 
            type: 'linear', 
            position: 'bottom',
            title: { display: true, text: "Workflow Count", font: { size: 14, weight: 'bold' } },
            grid: { color: 'rgba(0, 0, 0, 0.05)' }
          }
        },
        plugins: { 
          legend: {
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 15,
              font: { size: 12, weight: '600' }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 13 },
            cornerRadius: 8
          },
          zoom: { 
            pan: { enabled: true, mode: 'x', speed: 10, threshold: 10 }, 
            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } 
          } 
        }
      }
    });
    var aggregatedCPU = [];
    var cpuCount = [];
    metricsData.forEach(function(metric) {
      if (metric.cpuUsage) {
        metric.cpuUsage.forEach(function(val, i) {
          if (typeof aggregatedCPU[i] === 'undefined') { aggregatedCPU[i] = 0; cpuCount[i] = 0; }
          aggregatedCPU[i] += val; cpuCount[i] += 1;
        });
      }
    });
    for (var i = 0; i < aggregatedCPU.length; i++) { aggregatedCPU[i] = aggregatedCPU[i] / cpuCount[i]; }
    var hostMemory = [];
    if (metricsData.length > 0) {
      var hostMetric = metricsData[0];
      metricsData.forEach(function(m) { if (m.pid < hostMetric.pid) { hostMetric = m; } });
      hostMemory = hostMetric.memoryUsage || [];
    }
    var maxLen = Math.max(aggregatedCPU.length, hostMemory.length);
    var labels2 = [];
    for (var i = 0; i < maxLen; i++) { labels2.push(" " + (i + 1)); }
    var cpuMemDatasets = [ {
      label: "CPU Usage (%)",
      data: new Array(maxLen - aggregatedCPU.length).fill(null).concat(aggregatedCPU),
      borderColor: "rgba(102, 126, 234, 1)",
      backgroundColor: "rgba(102, 126, 234, 0.1)",
      fill: true,
      tension: 0.4,
      borderWidth: 3,
      pointRadius: 4,
      pointHoverRadius: 6,
      pointBackgroundColor: "rgba(102, 126, 234, 1)",
      pointBorderColor: '#fff',
      pointBorderWidth: 2
    },
    {
      label: "Memory Usage (%)",
      data: new Array(maxLen - hostMemory.length).fill(null).concat(hostMemory),
      borderColor: "rgba(245, 87, 108, 1)",
      backgroundColor: "rgba(245, 87, 108, 0.1)",
      fill: true,
      tension: 0.4,
      borderWidth: 3,
      pointRadius: 4,
      pointHoverRadius: 6,
      pointBackgroundColor: "rgba(245, 87, 108, 1)",
      pointBorderColor: '#fff',
      pointBorderWidth: 2
    }];
    var ctx2 = document.getElementById("cpuMemChart").getContext("2d");
    new Chart(ctx2, {
      type: "line",
      data: { labels: labels2, datasets: cpuMemDatasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 750, easing: 'easeInOutQuart' },
        scales: {
          x: { 
            beginAtZero: true, 
            title: { display: true, text: "Time (seconds)", font: { size: 14, weight: 'bold' } }, 
            type: 'linear', 
            position: 'bottom',
            grid: { color: 'rgba(0, 0, 0, 0.05)' }
          },
          y: { 
            beginAtZero: true, 
            max: 100,
            title: { display: true, text: "Usage (%)", font: { size: 14, weight: 'bold' } },
            grid: { color: 'rgba(0, 0, 0, 0.05)' }
          }
        },
        plugins: { 
          legend: {
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 15,
              font: { size: 12, weight: '600' }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 13 },
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
              }
            }
          },
          zoom: { 
            pan: { enabled: true, mode: 'x', speed: 10, threshold: 10 }, 
            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } 
          } 
        }
      }
    });
    var pidSelect = document.getElementById("pidFilter");
    var optionAll = document.createElement("option");
    optionAll.value = "";
    optionAll.text = "All PIDs";
    pidSelect.appendChild(optionAll);
    var uniquePIDs = [];
    metricsData.forEach(function(metric) { if (metric.pid != null && uniquePIDs.indexOf(metric.pid) === -1) { uniquePIDs.push(metric.pid); } });
    uniquePIDs.sort(function(a, b) { return a - b; });
    uniquePIDs.forEach(function(pid) { var option = document.createElement("option"); option.value = pid; option.text = pid; pidSelect.appendChild(option); });
    function loadLogs() {
      var pid = document.getElementById("pidFilter").value;
      var url = "/console";
      if (pid) {
        url += "?pid=" + encodeURIComponent(pid);
      }

      fetch(url)
        .then(response => response.json())
        .then(data => {
          var container = document.getElementById("logsContainer");
          container.innerHTML = "";

          if (!data || data.length === 0) {
            container.innerHTML = "<p>No logs found.</p>";
            return;
          }

          // Track parameters by PID
          const pidParamsMap = {};

          // Create a Bootstrap table
          var table = document.createElement("table");
          table.classList.add("table", "table-dark", "table-striped", "table-sm");

          // Create a thead with column headers
          var thead = document.createElement("thead");
          thead.innerHTML = `
            <tr>
              <th style="width: 180px;">Time</th>
              <th style="width: 60px;">PID</th>
              <th>Log</th>
            </tr>
          `;
          table.appendChild(thead);

          // Create a tbody to hold log rows
          var tbody = document.createElement("tbody");

          data.forEach(function(entry) {
            const pid = entry.pid;
            const param = entry.parameters;

            // Maintain pidParamsMap for later display
            if (!pidParamsMap[pid]) {
              pidParamsMap[pid] = new Set();
            }
            pidParamsMap[pid].add(param);

            // Build a table row for each log entry
            var row = document.createElement("tr");
            var timestamp = new Date(entry.timestamp).toLocaleString();

            row.innerHTML = `
              <td style="color: green;">${timestamp}</td>
              <td style="color: LightGreen;">${pid}</td>
              <td style="color: white;">${entry.log}</td>
            `;
            tbody.appendChild(row);
          });

          table.appendChild(tbody);
          container.appendChild(table);

          // Now populate the PID parameters section
          const containerParams = document.getElementById("pidParamsContainer");
          containerParams.innerHTML = "";

          let selectedPid = document.getElementById("pidFilter").value;
          if (!selectedPid) {
            // Show params for all PIDs
            for (const [pid, paramsSet] of Object.entries(pidParamsMap)) {
              let paramString = Array.from(paramsSet).join(", ");
              containerParams.innerHTML += `
                <h5>
                  <span class="badge bg-dark">
                    PID: <span class="badge bg-light" style="color: black;">${pid}</span>
                  </span>
                  <span class="badge bg-secondary" style="flex:1;">
                    Params: <span class="badge bg-light" style="color: black;">${paramString}</span>
                  </span>
                </h5>`;
            }
          } else {
            // Show params only for the selected PID
            let paramsSet = pidParamsMap[selectedPid];
            if (paramsSet) {
              let paramString = Array.from(paramsSet).join(", ");
              containerParams.innerHTML += `
                <h5>
                  <span class="badge bg-dark">
                    PID: <span class="badge bg-light" style="color: black;">${selectedPid}</span>
                  </span>
                  <span class="badge bg-secondary" style="flex:1;">
                    Params: <span class="badge bg-light" style="color: black;">${paramString}</span>
                  </span>
                </h5>`;
            } else {
              containerParams.innerHTML = `<p>No logs found for PID ${selectedPid}.</p>`;
            }
          }
        })
        .catch(err => {
          console.error("Error loading logs:", err);
        });
    }

    var loadLogsButton = document.getElementById("loadLogs");
    if (loadLogsButton) {
      loadLogsButton.addEventListener("click", function() { loadLogs(); });
    }
    var consoleModal = document.getElementById("consoleModal");
    if (consoleModal) {
      consoleModal.addEventListener('show.bs.modal', function() { 
        autoRefreshPausedByModal = true;
        stopAutoRefresh(); 
        loadLogs(); 
      });
      consoleModal.addEventListener('hidden.bs.modal', function() { 
        autoRefreshPausedByModal = false;
        startAutoRefresh(); 
      });
    }
    
    var startProcessModal = document.getElementById("startProcessModal");
    if (startProcessModal) {
      startProcessModal.addEventListener('show.bs.modal', function() { 
        autoRefreshPausedByModal = true;
        stopAutoRefresh(); 
      });
      startProcessModal.addEventListener('hidden.bs.modal', function() { 
        autoRefreshPausedByModal = false;
        startAutoRefresh(); 
      });
    }
    
    var startAppModal = document.getElementById("startAppModal");
    if (startAppModal) {
      startAppModal.addEventListener('show.bs.modal', function() { 
        autoRefreshPausedByModal = true;
        stopAutoRefresh(); 
      });
      startAppModal.addEventListener('hidden.bs.modal', function() { 
        autoRefreshPausedByModal = false;
        startAutoRefresh(); 
      });
    }
    
    var killModal = document.getElementById("killModal");
    if (killModal) {
      killModal.addEventListener('show.bs.modal', function() { 
        autoRefreshPausedByModal = true;
        stopAutoRefresh(); 
      });
      killModal.addEventListener('hidden.bs.modal', function() { 
        autoRefreshPausedByModal = false;
        startAutoRefresh(); 
      });
    }
    var refreshIntervalId2 = null;
    function startLogsAutoRefresh(interval) { if (!refreshIntervalId2) { refreshIntervalId2 = setInterval(loadLogs, interval * 1000); } }
    function stopLogsAutoRefresh() { if (refreshIntervalId2) { clearInterval(refreshIntervalId2); refreshIntervalId2 = null; } }
    var autoRefreshLogsCheckbox = document.getElementById("autoRefreshLogsCheckbox");
    var refreshIntervalSelect = document.getElementById("logsRefreshInterval");
    pidSelect.addEventListener("change", function() { loadLogs(); });
    autoRefreshLogsCheckbox.addEventListener("change", function(){ if(this.checked) { startLogsAutoRefresh(parseInt(refreshIntervalSelect.value)); } else { stopLogsAutoRefresh(); } });
    refreshIntervalSelect.addEventListener("change", function(){ if(autoRefreshLogsCheckbox.checked) { stopLogsAutoRefresh(); startLogsAutoRefresh(parseInt(this.value)); } });
    // Add PID info below the graphs with modern styling
    var pidInfoContainer = document.getElementById("pidParamsContainerOnDashboard");
    pidInfoContainer.innerHTML = "";
    var table = document.createElement("table");
    table.classList.add("table", "table-hover");
    var thead = document.createElement("thead");
    thead.innerHTML = `
      <tr>
        <th><i class="fas fa-bars"></i> Actions</th>
        <th><i class="fas fa-hashtag"></i> PID</th>
        <th><i class="fas fa-info-circle"></i> Status</th>
        <th><i class="fas fa-hourglass-half"></i> Time Left</th>
        <th><i class="fas fa-spinner"></i> Active</th>
        <th><i class="fas fa-play"></i> Started</th>
        <th><i class="fas fa-check"></i> Completed</th>
        <th><i class="fas fa-times"></i> Failed</th>
        <th><i class="fas fa-clock"></i> Avg Time</th>
        <th><i class="fas fa-cog"></i> Parameters</th>
      </tr>
    `;
    table.appendChild(thead);
    var tbody = document.createElement("tbody");
    metricsData.forEach(function(metric) {
      var avgCompletionTime = metric.durations.reduce((a, b) => a + b, 0) / metric.durations.length;
      var row = document.createElement("tr");
      row.innerHTML = `
        <td style="text-align: center;">
          <i class="fas fa-file-alt action-icon logs" onclick="openLogsModal(${metric.pid})" data-tippy-content="View Logs"></i>
          <i class="fas fa-skull-crossbones action-icon kill" onclick="confirmKill(${metric.pid}, '${metric.params || '-dashboard'}')" data-tippy-content="Terminate Process"></i>
        </td>
        <td><strong>${metric.pid}</strong></td>
        <td><span class="badge bg-info">${metric.status || 'Running'}</span></td>
        <td>${(typeof metric.timeLeft !== 'undefined' && metric.timeLeft !== null && metric.timeLeft !== 0) ? '<span class="badge bg-warning text-dark">' + metric.timeLeft + 's</span>' : '<span class="badge bg-secondary">-</span>'}</td>
        <td>${metric.activeWorkflows || '0'}</td>
        <td>${metric.totalWorkflowsStarted || '0'}</td>
        <td><span class="badge bg-success">${metric.totalWorkflowsCompleted || '0'}</span></td>
        <td><span class="badge bg-danger">${metric.totalWorkflowsFailed || '0'}</span></td>
        <td>${isNaN(avgCompletionTime) ? '-' : '<strong>' + avgCompletionTime.toFixed(2) + 's</strong>'}</td>
        <td><code>${metric.params || '-dashboard'}</code></td>
      `;
      tbody.appendChild(row);
    });
    table.appendChild(tbody);
    pidInfoContainer.appendChild(table);
  });

  function openLogsModal(pid) {
    var pidFilter = document.getElementById("pidFilter");
    pidFilter.value = pid;
    var consoleModal = new bootstrap.Modal(document.getElementById("consoleModal"));
    consoleModal.show();
    loadLogs();
  }

  function start3270ConnectProcess() {
    var errorsDiv = document.getElementById('processErrors');
    errorsDiv.innerHTML = '';
    var formElem = document.getElementById('startProcessForm');
    
    // Check if form is valid using form.checkValidity()
    if (!formElem.checkValidity()) {
      errorsDiv.innerHTML = '<div class="alert alert-danger">Please complete all required fields.</div>';
      return;
    }
    
    var configFileInput = document.getElementById('configFileInput');
    // Additionally trap error if configuration file is not supplied
    if (!configFileInput.files || configFileInput.files.length === 0) {
      errorsDiv.innerHTML = '<div class="alert alert-danger">Configuration file is required.</div>';
      return;
    }
    
    // All required fields provided; build FormData manually
    var formData = new FormData();
    formData.append("configFile", configFileInput.files[0]);

    var injectionConfigInput = document.getElementById('injectionConfigInput');
    if (injectionConfigInput.files && injectionConfigInput.files.length > 0) {
      formData.append("injectionConfig", injectionConfigInput.files[0]);
    }

    formData.append("concurrent", document.getElementById('concurrentInput').value);
    formData.append("runtime", document.getElementById('runtimeInput').value);
    formData.append("startPort", document.getElementById('startPortInput').value);
    formData.append("headless", document.getElementById('headlessInput').checked ? "on" : "off");
  
    fetch('/start-process', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        toastr.success('Process started successfully!');
        var modalEl = document.getElementById("startProcessModal");
        var modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) {
          modalInstance.hide();
          setTimeout(function() {
          window.location.href = window.location.href;
          }, 5000);
        }
      } else {
        return response.text().then((text) => {
          toastr.error(`Failed to start process: ${String(text)}`);
        });
      }
    })
    .catch(error => {
      console.error('Error starting process:', error);
      toastr.error(`An error occurred while starting the process: ${String(error.message)}`);
    });
  }

  // New function to handle starting the sample 3270 App
  function start3270App() {
    var errorsDiv = document.getElementById('appProcessErrors');
    errorsDiv.innerHTML = '';
    var formElem = document.getElementById('startAppForm');
    if (!formElem.checkValidity()) {
      errorsDiv.innerHTML = '<div class="alert alert-danger">Please complete all required fields.</div>';
      return;
    }
    var runApp = document.getElementById('runAppSelect').value;
    var runAppPort = document.getElementById('runAppPortInput').value;
    // Build FormData with runApp params
    var formData = new FormData();
    formData.append("runApp", runApp);
    formData.append("runAppPort", runAppPort);
  
    fetch('/start-process', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        toastr.success('Sample app started successfully!');
      } else {
        return response.text().then((text) => {
          toastr.error(`Failed to start sample app: ${String(text)}`);
        });
      }
    })
    .catch(error => {
      console.error('Error starting sample app:', error);
      toastr.error(`An error occurred while starting the sample app: ${String(error.message)}`);
    });
    
    var modalEl = document.getElementById("startAppModal");
    var modalInstance = bootstrap.Modal.getInstance(modalEl);
    if (modalInstance) {
      modalInstance.hide();
    }
    setTimeout(function() {
      window.location.href = window.location.href;
    }, 5000);
  }

  // Create a mapping for extended metrics keyed by PID
  var extendedMetrics = {
    {{range .ExtendedMetricsList}}
      "{{.PID}}": {
        status: "{{.Status}}",
        timeLeft: "{{.TimeLeft}}"
      },
    {{end}}
  };

  document.addEventListener('DOMContentLoaded', function () {
    // Initialize default tooltips with an offset
    tippy('[data-tippy-content]', {
      placement: 'top',
      animation: 'fade',
      theme: 'light',
      popperOptions: {
        modifiers: [ {
          name: 'offset',
          options: { offset: [0, 8] }
        } ]
      }
    });
    // Specific settings for auto refresh toggle tooltip
    tippy('#autoRefreshToggle', {
      content: document.querySelector('#autoRefreshToggle').getAttribute('data-tippy-content') || "Enable or disable automatic page refresh.",
      placement: 'right',
      animation: 'fade',
      theme: 'light',
      popperOptions: {
        modifiers: [ {
          name: 'offset',
          options: { offset: [20, 0] }
        } ]
      }
    });
    // Specific settings for refresh period select tooltip
    tippy('#refreshPeriodSelect', {
      content: document.querySelector('#refreshPeriodSelect').getAttribute('data-tippy-content') || "Set the interval for automatic page refresh in seconds.",
      placement: 'right',
      animation: 'fade',
      theme: 'light',
      popperOptions: {
        modifiers: [ {
          name: 'offset',
          options: { offset: [20, 0] }
        } ]
      }
    });
  });

  // Set toastr options
  toastr.options = {
    "closeButton": false,
    "debug": false,
    "newestOnTop": true,
    "progressBar": true,
    "positionClass": "toast-top-right",
    "preventDuplicates": false,
    "onclick": null,
    "showDuration": "300",
    "hideDuration": "1000",
    "timeOut": "5000",
    "extendedTimeOut": "1000",
    "showEasing": "swing",
    "hideEasing": "linear",
    "showMethod": "fadeIn",
    "hideMethod": "fadeOut"
  };

  function confirmKill(pid, params) {
    document.getElementById("killDetails").innerHTML = `
      <p>Are you sure you want to kill the following process?</p>
      <div class="alert alert-info">
      <strong>PID:</strong> ${pid}<br>
      <strong>Parameters:</strong> ${params}
      </div>
    `;
    var killModal = new bootstrap.Modal(document.getElementById("killModal"));
    document.getElementById("confirmKillBtn").onclick = function() {
      killProcess(pid);
    };
    killModal.show();
  }

  function killProcess(pid) {
    fetch('/kill?pid=' + encodeURIComponent(pid), { method: 'POST' })
      .then(response => {
        return response.text().then(text => {
          if (response.ok) {
            toastr.success(text);
          } else {
            toastr.error(text);
          }
        });
      });
    var killModal = document.getElementById("killModal");
    var modalInstance = document.getElementById("killModal");
    var modalInstance = bootstrap.Modal.getInstance(killModal);
    if (modalInstance) {
        modalInstance.hide();
    }
    setTimeout(function() {
      window.location.href = window.location.href;
    }, 5000);
  }

  document.getElementById("closeModal").onclick = function() {
    var killModal = document.getElementById("killModal");
    var modalInstance = bootstrap.Modal.getInstance(killModal);
    if (modalInstance) {
        modalInstance.hide();
    }
    setTimeout(function() {
      window.location.href = window.location.href;
    }, 5000);
  };
</script>
</body>
</html>
